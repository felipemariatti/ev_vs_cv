<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard EV vs ICE - VERS√ÉO FINAL</title>

    <style>
        /* ====== VARI√ÅVEIS E CONFIG GLOBAL (inalterado) ====== */
        :root{
            --grad-bg: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
            --grad-btn: linear-gradient(135deg,#10b981 0%,#059669 100%);
            --borda: rgba(255,255,255,0.25);
        }
        *{margin:0;padding:0;box-sizing:border-box;}
        html,body{height:100%;overflow:hidden;}
        body{
            font-family:"Segoe UI",Tahoma,sans-serif;
            background:var(--grad-bg);color:#fff;
            display:flex;flex-direction:column;justify-content:center;align-items:center;
            padding:24px;
        }

        /* ====== CABE√áALHO ====== */
        .header{
            width:100%;max-width:1400px;background:rgba(255,255,255,0.2);
            border-radius:10px;padding:8px 18px;margin-bottom:10px;
            display:flex;justify-content:space-between;align-items:center;
            box-shadow:0 3px 10px rgba(0,0,0,0.2);
        }
        .header h1{font-size:1.2rem;}

        /* ====== GRID PRINCIPAL ====== */
        .dashboard{
            display:grid;grid-template-columns:1fr 1fr 1fr;grid-template-rows:auto auto;
            gap:8px;width:100%;max-width:1400px;
        }

        /* ====== CARDS PADR√ÉO ====== */
        .card{
            background:rgba(255,255,255,0.15);border:1px solid var(--borda);
            border-radius:12px;padding:8px;backdrop-filter:blur(6px);
            box-shadow:0 3px 8px rgba(0,0,0,0.15);
        }
        .card h3{
            font-size:0.9rem;font-weight:700;border-bottom:1.5px solid rgba(255,255,255,0.3);
            padding-bottom:3px;margin-bottom:6px;
        }

        /* ====== FORM ====== */
        label{font-size:0.75rem;font-weight:600;color:#fff;}
        input,select{
            width:100%;padding:5px 7px;border-radius:8px;
            border:1.5px solid rgba(255,255,255,0.5);
            background:rgba(255,255,255,0.4);color:#111;font-size:0.85rem;
        }

        /* ====== VE√çCULOS ====== */
        .vehicle-img{width:100%;height:120px;object-fit:contain;border-radius:8px;background:#fff;margin:6px 0;}
        .vehicle-info{
            display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));
            gap:6px;min-height:85px;
        }
        .v-card{
            background:rgba(255,255,255,0.5);border-radius:8px;text-align:center;padding:6px;color:#111;font-size:0.7rem;
            height:70px;display:flex;flex-direction:column;justify-content:center;
        }
        .v-card img{width:20px;height:20px;margin:0 auto 2px;display:block;}
        .v-card .emoji{display:block;font-size:1.1rem;}
        .v-card .value{font-weight:bold;}

        /* ====== PERFIL ====== */
        .profile-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;}
        .profile-pill{
            background:rgba(255,255,255,0.4);
            border:1.5px solid rgba(255,255,255,0.5);
            border-radius:10px;padding:8px;display:flex;align-items:center;gap:10px;
            color:#111;cursor:pointer;transition:0.25s;
        }
        .profile-pill:hover{background:rgba(255,255,255,0.65);}
        .profile-pill.active{background:var(--grad-btn);color:#fff;border:none;}
        .profile-emoji{font-size:1.9rem;line-height:1;}
        .profile-info{display:flex;flex-direction:column;line-height:1.15;}
        .profile-info .name{font-weight:700;font-size:0.85rem;}
        .profile-info .details{font-size:0.72rem;}

        /* ====== CEN√ÅRIOS ====== */
        .scenario-row{display:flex;gap:6px;margin-bottom:6px;}
        .scenario-btn{
            flex:1;border-radius:8px;padding:5px 6px;border:1.5px solid rgba(255,255,255,0.5);
            background:rgba(255,255,255,0.4);color:#111;font-weight:700;font-size:0.75rem;cursor:pointer;transition:0.25s;
            display:flex;justify-content:center;align-items:center;gap:5px;
        }
        .scenario-btn.active{background:var(--grad-btn);color:#fff;border:none;}
        .inputs-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:4px;}
        .inputs-grid-2{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:4px;}
        .btn-calc{width:100%;background:var(--grad-btn);color:#fff;border:none;border-radius:8px;font-weight:700;padding:8px;cursor:pointer;}

        /* ====== RESULTADOS ====== */
        .result-card{
            grid-column:2/3;grid-row:2/span 2;background:rgba(255,255,255,0.15);
            border:1px solid var(--borda);border-radius:12px;padding:8px;backdrop-filter:blur(6px);
            box-shadow:0 3px 10px rgba(0,0,0,0.25);display:flex;flex-direction:column;justify-content:flex-start;
        }
        .result-card h3{font-size:0.9rem;font-weight:700;border-bottom:1.5px solid rgba(255,255,255,0.3);padding-bottom:3px;margin-bottom:8px;}
        .result-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
        .result-col{display:flex;flex-direction:column;gap:8px;}
        .result-box{
            background:linear-gradient(135deg,#6b73ff 0%,#8b5cf6 100%);
            border-radius:12px;text-align:center;padding:12px 10px;color:#fff;box-shadow:0 3px 10px rgba(0,0,0,0.25);
            height:73px;display:flex;flex-direction:column;justify-content:center;
        }
        .result-box h4{margin:0;font-size:0.9rem;font-weight:600;}
        .result-box .value{font-weight:bold;font-size:1.05rem;margin-top:5px;}
        .result-payback{grid-column:1/span 2;margin-top:6px;}

        /* ====== COLUNA DIREITA (gr√°ficos) ====== */
        .card-reservado{
            grid-column:3/4;grid-row:1 / span 3;display:grid;grid-template-rows:0.5fr 1fr 1fr 1fr;gap:8px;
        }
        .card-reservado .subcard{
            background:rgba(255,255,255,0.12);border:1px solid var(--borda);border-radius:12px;padding:10px;backdrop-filter:blur(6px);
            box-shadow:0 3px 10px rgba(0,0,0,0.25);display:flex;flex-direction:column;justify-content:center;align-items:center;
            font-weight:700;font-size:1rem;color:#fff;text-align:center;overflow:hidden;position:relative;
        }

        /* ====== CONCLUS√ÉO ====== */
        #conclusaoBox{display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;font-weight:600;padding:14px;}
        #conclusaoBox .emoji-top{font-size:2.2rem;line-height:1;margin-bottom:4px;}
        #conclusaoBox .texto{font-size:0.9rem;line-height:1.3rem;}

        /* ====== GR√ÅFICOS ====== */
        #grafico1,#grafico2,#grafico3{padding:8px!important;}
    </style>
</head>

<body>
<div class="header">
    <h1>‚ö° An√°lise Econ√¥mica: EV vs ICE - VERS√ÉO FINAL</h1>
    <span style="font-size:0.8rem;opacity:0.8;">Fluxo de caixa completo</span>
</div>


<div class="dashboard">
    <!-- EV -->
    <div class="card" id="cardEV">
        <h3>‚ö° Ve√≠culo El√©trico</h3>
        <label>Modelo:</label>
        <select id="selEV"><option>Selecione um modelo</option></select>
        <label>üí∞ Pre√ßo (R$):</label>
        <input id="precoEV">
        <img id="imgEV" class="vehicle-img" src="https://i.imgur.com/MLNARfh.png" alt="EV">
        <div id="infoEV" class="vehicle-info"></div>
    </div>

    <!-- ICE -->
    <div class="card" id="cardICE">
        <h3>‚õΩ Ve√≠culo Combust√£o</h3>
        <label>Modelo:</label>
        <select id="selICE"><option>Selecione um modelo</option></select>
        <label>üí∞ Pre√ßo (R$):</label>
        <input id="precoICE">
        <img id="imgICE" class="vehicle-img" src="https://i.imgur.com/MLNARfh.png" alt="ICE">
        <div id="infoICE" class="vehicle-info"></div>
    </div>

    <!-- PERFIL -->
    <div class="card" style="grid-column:1/2;">
        <h3>üë§ Perfil</h3>
        <div id="perfisContainer" class="profile-grid">Carregando...</div>
    </div>

    <!-- CEN√ÅRIO -->
    <div class="card" style="grid-column:1/2;">
        <h3>üéØ Cen√°rio</h3>
        <div id="cenariosContainer" class="scenario-row"></div>
        <div class="inputs-grid">
            <div><label>Tarifa Res. (R$/kWh):</label><input id="tarifaRes"></div>
            <div><label>Tarifa P√∫b. (R$/kWh):</label><input id="tarifaPub"></div>
            <div><label>Gasolina (R$/L):</label><input id="precoGas"></div>
        </div>
        <div class="inputs-grid-2">
            <div><label>Per√≠odo (anos):</label><input id="anos" type="text" inputmode="decimal" placeholder="ex: 1,5"></div>
            <div><label>TMA (%):</label><input id="tma"></div>
        </div>
        <button class="btn-calc" id="btnCalcular">üöÄ CALCULAR</button>
    </div>

    <!-- RESULTADOS -->
    <div class="result-card">
        <h3>üìä Resultados</h3>
        <div class="result-grid">
            <div class="result-col">
                <div class="result-box"><h4>‚ö° R$/KM EV</h4><span class="value" id="resEV">‚Äî</span></div>
                <div class="result-box"><h4>üåø Custo Anual EV</h4><span class="value" id="custoEV">‚Äî</span></div>
                <div class="result-box"><h4>üìâ VPL EV</h4><span class="value" id="vpl_ev">‚Äî</span></div>
                <div class="result-box"><h4>üìà TIR EV</h4><span class="value" id="tir_ev">‚Äî</span></div>
            </div>
            <div class="result-col">
                <div class="result-box"><h4>‚õΩ R$/KM ICE</h4><span class="value" id="resICE">‚Äî</span></div>
                <div class="result-box"><h4>üî• Custo Anual ICE</h4><span class="value" id="custoICE">‚Äî</span></div>
                <div class="result-box"><h4>üìâ VPL ICE</h4><span class="value" id="vpl_ice">‚Äî</span></div>
                <div class="result-box"><h4>üìà TIR ICE</h4><span class="value" id="tir_ice">‚Äî</span></div>
            </div>
            <div class="result-box result-payback">
                <h4>‚è≥ Payback Descontado</h4><span class="value" id="payback">‚Äî</span>
            </div>
        </div>
    </div>

    <!-- COLUNA DE GR√ÅFICOS (id√™ntica) -->
    <div class="card-reservado">
        <div class="subcard" id="conclusaoBox">‚úÖ Conclus√£o</div>
        <div class="subcard" id="grafico1">üìä Fluxo de Caixa</div>
        <div class="subcard" id="grafico2">‚è≥ Payback</div>
        <div class="subcard" id="grafico3">üí∞ Custos</div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    /* =================== UTIL =================== */
    const URLS={
        VEICULOS:"https://docs.google.com/spreadsheets/d/e/2PACX-1vSUihOaIXPK9JWb5tXTp3YB0ALT-YIwVdZEeUtMa_CY8chVqzBayBQpnxQTkqLhvPwLVNgddsmZXGAo/pub?gid=0&single=true&output=csv",
        PERFIS:"https://docs.google.com/spreadsheets/d/e/2PACX-1vSUihOaIXPK9JWb5tXTp3YB0ALT-YIwVdZEeUtMa_CY8chVqzBayBQpnxQTkqLhvPwLVNgddsmZXGAo/pub?gid=155387580&single=true&output=csv",
        CENARIOS:"https://docs.google.com/spreadsheets/d/e/2PACX-1vSUihOaIXPK9JWb5tXTp3YB0ALT-YIwVdZEeUtMa_CY8chVqzBayBQpnxQTkqLhvPwLVNgddsmZXGAo/pub?gid=1970963524&single=true&output=csv"
    };
    const toNumBR=v=>parseFloat(String(v||"").replace(/\./g,"").replace(",",".").trim())||0;
    const moneyBR=n=>"R$ "+(Number(n)||0).toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2});
    const moneyBR4=n=>"R$ "+(Number(n)||0).toLocaleString("pt-BR",{minimumFractionDigits:4,maximumFractionDigits:4});
    const fmtPct = n => (Number(n)||0).toLocaleString("pt-BR",{minimumFractionDigits:0,maximumFractionDigits:0})+"%";
    function formatPayback(val){
        if(isNaN(val)) return "Sem payback";
        if(val<1){const m=Math.max(1,Math.round(val*12));return `${m} mes${m!==1?'es':''}`;}
        const a=Math.floor(val),m=Math.round((val-a)*12);
        return `${a} ano${a!==1?'s':''}`+(m>0?` e ${m} mes${m!==1?'es':''}`:"");
    }
    async function getCSV(url){
        const res=await fetch(url); const text=await res.text();
        const lines=text.trim().split(/\r?\n/).map(l=>l.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c=>c.replace(/^"|"$|/g,'')));
        const headers=lines.shift();
        return lines.map(row=>{
            const o={}; headers.forEach((h,i)=>o[h.trim()]=(row[i]||'').trim()); return o;
        });
    }

    /* =================== ESTADO =================== */
    let dataVeiculos=[],dataPerfis=[],dataCenarios=[];
    let selecionadoEV=null,selecionadoICE=null,selecionadoPerfil=null,selecionadoCenario=null;
    let chartFluxo=null, chartPayback=null, chartCustoKm=null, graficosInicializados=false;

    /* objeto √∫nico de sa√≠das para reuso */
    const dadosAtuais = {
        // params
        tma: NaN, anos: 0,
        precoEV:0, precoICE:0, custoAnualEV:0, custoAnualICE:0, resPctEV:0, resPctICE:0,
        // fluxos
        fluxoEV:[], fluxoICE:[],
        // m√©tricas
        vplEV:NaN, vplICE:NaN, tirEV:NaN, tirICE:NaN, payback:NaN,
        // util para gr√°ficos de VPL por per√≠odo
        vplSerieEV:[], vplSerieICE:[],
        // custos vari√°veis
        custoKmEV:0, custoKmICE:0
    };

    /* =================== UI (listas) =================== */
    function popularVeiculos(){
        const selEV=document.getElementById('selEV');
        const selICE=document.getElementById('selICE');
        selEV.innerHTML='<option>Selecione um modelo</option>';
        selICE.innerHTML='<option>Selecione um modelo</option>';

        const tpl=(isEV)=>`
    <div class="v-card"><span class="emoji">üìÖ</span>Ano<br><span class="value">‚Äî</span></div>
    <div class="v-card"><span class="emoji">${isEV?'‚ö°':'‚õΩ'}</span>Consumo Urb.<br><span class="value">‚Äî</span></div>
    <div class="v-card"><span class="emoji">${isEV?'‚ö°':'‚õΩ'}</span>Consumo Rod.<br><span class="value">‚Äî</span></div>
    <div class="v-card"><span class="emoji">üõ†Ô∏è</span>Manuten√ß√£o<br><span class="value">‚Äî</span></div>
    <div class="v-card"><span class="emoji">üßæ</span>Seguro<br><span class="value">‚Äî</span></div>
    <div class="v-card"><span class="emoji">üí∞</span>IPVA<br><span class="value">‚Äî</span></div>
    <div class="v-card"><img src="https://i.imgur.com/kQOANzQ.png" alt="Pneus">Pneus<br><span class="value">‚Äî</span></div>
    <div class="v-card"><span class="emoji">üíµ</span>Residual<br><span class="value">‚Äî</span></div>`;
        if(!document.querySelector('#infoEV .v-card')) document.getElementById('infoEV').innerHTML=tpl(true);
        if(!document.querySelector('#infoICE .v-card')) document.getElementById('infoICE').innerHTML=tpl(false);

        for(const v of dataVeiculos.filter(v=>v.tipo.toUpperCase()==='EV')){
            const o=document.createElement('option'); o.value=v.modelo; o.textContent=v.modelo; selEV.appendChild(o);
        }
        for(const v of dataVeiculos.filter(v=>v.tipo.toUpperCase()==='ICE')){
            const o=document.createElement('option'); o.value=v.modelo; o.textContent=v.modelo; selICE.appendChild(o);
        }
    }
    function setInfoVeiculo(v, infoId, precoId, imgId, isEV){
        const infoEl=document.getElementById(infoId);
        const precoEl=document.getElementById(precoId);
        const imgEl=document.getElementById(imgId);
        if(!v){
            precoEl.value=''; imgEl.src='https://i.imgur.com/MLNARfh.png';
            infoEl.querySelectorAll('.value').forEach(e=>e.textContent='‚Äî'); return;
        }
        precoEl.value = toNumBR(v.preco_inicial).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});
        imgEl.src=v.imagem||'https://i.imgur.com/MLNARfh.png';

        const setVal=(label,val)=>{
            const card=[...infoEl.querySelectorAll('.v-card')].find(c=>c.textContent.includes(label));
            if(card) card.querySelector('.value').textContent=val;
        };
        setVal('Ano',v.ano||'‚Äî');
        setVal('Consumo Urb.',v.consumo_urb?toNumBR(v.consumo_urb).toLocaleString('pt-BR',{minimumFractionDigits:2})+(isEV?' km/kWh':' km/L'):'‚Äî');
        setVal('Consumo Rod.',v.consumo_rod?toNumBR(v.consumo_rod).toLocaleString('pt-BR',{minimumFractionDigits:2})+(isEV?' km/kWh':' km/L'):'‚Äî');
        setVal('Manuten√ß√£o',v.manutencao_anual?moneyBR(toNumBR(v.manutencao_anual)):'‚Äî');
        setVal('Seguro',v.seguro_anual?moneyBR(toNumBR(v.seguro_anual)):'‚Äî');
        setVal('IPVA',v.ipva_anual?moneyBR(toNumBR(v.ipva_anual)):'‚Äî');
        setVal('Pneus',v.pneus_ano?moneyBR(toNumBR(v.pneus_ano)):'‚Äî');
        const resPct=v['residual_%']?(toNumBR(v['residual_%'])*100).toFixed(0)+'%':'‚Äî';
        setVal('Residual',resPct);
    }
    function popularPerfis(){
        const box=document.getElementById('perfisContainer'); box.innerHTML='';
        dataPerfis.forEach((p,i)=>{
            const perfil=p.perfil.toLowerCase();
            const emoji=perfil.includes('app')?'üì±':perfil.includes('via')?'üõ£Ô∏è':perfil.includes('pes')?'üöô':'üè†';
            const div=document.createElement('div');
            div.className='profile-pill'+(i===0?' active':''); if(i===0) selecionadoPerfil=p;
            div.innerHTML = `
      <div class="profile-emoji">${emoji}</div>
      <div class="profile-info">
        <div class="name">${p.perfil}</div>
        <div class="details">${toNumBR(p.km_ano).toLocaleString('pt-BR')} km/ano</div>
        <div class="details">Recarga P√∫blica: ${fmtPct(toNumBR(p['%_recarga_publica'])*100)} ‚Ä¢ Rodovia: ${fmtPct(toNumBR(p['%_rodovia'])*100)}</div>
      </div>`;
            div.onclick=()=>{document.querySelectorAll('.profile-pill').forEach(b=>b.classList.remove('active'));div.classList.add('active');selecionadoPerfil=p;};
            box.appendChild(div);
        });
    }
    function popularCenarios(){
        const wrap=document.getElementById('cenariosContainer'); wrap.innerHTML='';
        dataCenarios.forEach(c=>{
            const nome=c.cenario.toLowerCase();
            const icon=nome.includes('otim')?'üìà':nome.includes('pess')?'üìâ':'üìä';
            const btn=document.createElement('button');
            btn.className='scenario-btn'; btn.innerHTML=`${icon} ${c.cenario}`;
            btn.onclick=()=>{
                document.querySelectorAll('.scenario-btn').forEach(b=>b.classList.remove('active'));
                btn.classList.add('active'); selecionadoCenario=c;
                document.getElementById('tarifaRes').value=c.tarifa_residencial_kwh;
                document.getElementById('tarifaPub').value=c.tarifa_publica_kwh;
                document.getElementById('precoGas').value=c.preco_gasolina;
                document.getElementById('tma').value=(toNumBR(c.tma)*100).toLocaleString('pt-BR',{minimumFractionDigits:0});
                document.getElementById('anos').value=toNumBR(c.periodo);
            };
            wrap.appendChild(btn);
        });
        const base=dataCenarios.find(c=>c.cenario.toLowerCase().includes('base'))||dataCenarios[0];
        if(base){wrap.querySelectorAll('.scenario-btn')[dataCenarios.indexOf(base)].click();}
    }

    /* =================== C√ÅLCULOS =================== */
    function gerarFluxoVeiculo(preco,custoAnual,residualPct,anos){
        const f=[-preco];
        for(let t=1;t<=anos;t++) f.push(-custoAnual+(t===anos?preco*residualPct:0));
        return f;
    }
    function calcularTIR(fluxos){
        function f(i){return fluxos.reduce((acc,fc,t)=>acc+fc/((1+i)**t),0);}
        let low=-0.9, high=1.0, mid, fLow=f(low), fHigh=f(high);
        if(fLow*fHigh>0) return NaN;
        for(let k=0;k<200;k++){
            mid=(low+high)/2; const fMid=f(mid);
            if(Math.abs(fMid)<1e-8) break;
            if(fLow*fMid<0){high=mid; fHigh=fMid;} else{low=mid; fLow=fMid;}
        }
        return mid;
    }
    function calcularPaybackDescontado(preco_ev,custoAnual_ev,residual_ev,preco_ice,custoAnual_ice,residual_ice,tma){
        let payback=NaN, maxAnos=30;
        for(let ano=1; ano<=maxAnos; ano++){
            const fator=(((1+tma)**ano-1)/(tma*((1+tma)**ano)));
            const vplEV=-preco_ev-(custoAnual_ev*fator)+((preco_ev*residual_ev)/((1+tma)**ano));
            const vplICE=-preco_ice-(custoAnual_ice*fator)+((preco_ice*residual_ice)/((1+tma)**ano));
            const dif=vplEV-vplICE;
            if(dif>0){
                if(ano===1){
                    const difAnt=(-preco_ev)-(-preco_ice);
                    const fracao=Math.abs(difAnt)/(dif-difAnt);
                    payback=fracao; // < 1 ano
                }else{
                    const fatorAnt=(((1+tma)**(ano-1)-1)/(tma*((1+tma)**(ano-1))));
                    const vplEV_ant=-preco_ev-(custoAnual_ev*fatorAnt)+((preco_ev*residual_ev)/((1+tma)**(ano-1)));
                    const vplICE_ant=-preco_ice-(custoAnual_ice*fatorAnt)+((preco_ice*residual_ice)/((1+tma)**(ano-1)));
                    const difAnt=vplEV_ant-vplICE_ant;
                    const fracao=Math.abs(difAnt)/(dif-difAnt);
                    payback=(ano-1)+fracao;
                }
                break;
            }
        }
        return payback;
    }
    /* s√©rie de VPL por per√≠odo ‚Äî usa mesma f√≥rmula do card */
    function construirSerieVPL(preco,custoAnual,residualPct,tma,anos){
        const serie=[-preco];
        for(let a=1;a<=anos;a++){
            const fator=(((1+tma)**a-1)/(tma*((1+tma)**a)));
            const vpl=-preco-(custoAnual*fator)+((preco*residualPct)/((1+tma)**a));
            serie.push(vpl);
        }
        return serie;
    }

    /* =================== RESULTADOS -> DOM =================== */
    function aplicarResultadosDOM() {
        const d=dadosAtuais;
        document.getElementById('resEV').textContent   = moneyBR4(d.custoKmEV);
        document.getElementById('resICE').textContent  = moneyBR4(d.custoKmICE);
        document.getElementById('custoEV').textContent = moneyBR(d.custoAnualEV);
        document.getElementById('custoICE').textContent= moneyBR(d.custoAnualICE);
        document.getElementById('vpl_ev').textContent  = moneyBR(d.vplEV);
        document.getElementById('vpl_ice').textContent = moneyBR(d.vplICE);
        document.getElementById('tir_ev').textContent  = isNaN(d.tirEV) ? "‚Äî" : (d.tirEV*100).toFixed(2)+"%";
        document.getElementById('tir_ice').textContent = isNaN(d.tirICE)? "‚Äî" : (d.tirICE*100).toFixed(2)+"%";
        document.getElementById('payback').textContent = formatPayback(d.payback);

        // Conclus√£o
        const conclusaoBox=document.getElementById("conclusaoBox");
        let concl="", cor="";
        const diff=Math.abs(d.vplEV-d.vplICE);
        const media=(Math.abs(d.vplEV)+Math.abs(d.vplICE))/2;
        const diffPct= media>0 ? (diff/media)*100 : 0;
        if(!isNaN(d.vplEV) && !isNaN(d.vplICE)){
            if(d.vplEV>d.vplICE && diffPct>5){ concl="üå± Vale a pena optar pelo carro el√©trico. Ele apresenta menor custo total ao longo dos anos nas condi√ß√µes analisadas."; cor="rgba(16,185,129,0.6)";}
            else if(d.vplEV<d.vplICE && diffPct>5){concl="‚õΩ Ainda vale mais a pena manter um carro a combust√£o. O custo total do el√©trico √© maior neste cen√°rio."; cor="rgba(239,68,68,0.6)";}
            else {concl="‚öñÔ∏è O resultado √© equilibrado. O carro el√©trico e o a combust√£o t√™m custos muito pr√≥ximos ‚Äî a decis√£o depende mais do uso e das prefer√™ncias pessoais."; cor="rgba(234,179,8,0.6)";}
        }else{
            concl="‚ö†Ô∏è N√£o foi poss√≠vel concluir a compara√ß√£o. Verifique se todos os dados dos ve√≠culos e do cen√°rio foram preenchidos."; cor="rgba(234,179,8,0.6)";
        }
        const emoji=concl.slice(0,2), texto=concl.slice(2).trim();
        conclusaoBox.innerHTML=`<div class="emoji-top">${emoji}</div><div class="texto">${texto}</div>`;
        conclusaoBox.style.background=cor;
    }

    /* =================== GR√ÅFICOS (usando dadosAtuais) =================== */
    function garantirCanvas(){
        if(graficosInicializados) return;
        document.getElementById('grafico1').innerHTML = `
    <h4 style="margin:0 0 6px 0;font-size:0.8rem;text-align:center;font-weight:700;">üìä Fluxo de Caixa EV √ó ICE</h4>
    <div style="width:100%;height:calc(100% - 30px);position:relative;"><canvas id="canvasFluxo"></canvas></div>`;
        document.getElementById('grafico2').innerHTML = `
    <h4 style="margin:0 0 6px 0;font-size:0.8rem;text-align:center;font-weight:700;">‚è≥ Payback Descontado</h4>
    <div style="width:100%;height:calc(100% - 30px);position:relative;"><canvas id="canvasPayback"></canvas></div>`;
        document.getElementById('grafico3').innerHTML = `
    <h4 style="margin:0 0 6px 0;font-size:0.8rem;text-align:center;font-weight:700;">üí∞ Custo por km</h4>
    <div style="width:100%;height:calc(100% - 30px);position:relative;"><canvas id="canvasCustoKm"></canvas></div>`;
        graficosInicializados=true;
    }
    function desenharGraficos() {
        garantirCanvas();
        const d = dadosAtuais;

        // Fluxo
        const ctxFluxo = document.getElementById('canvasFluxo').getContext('2d');
        const labels = Array.from({length: d.anos + 1}, (_, i) => `Ano ${i}`);
        if (chartFluxo) chartFluxo.destroy();
        chartFluxo = new Chart(ctxFluxo, {
            type: 'bar',
            data: {
                labels, datasets: [
                    {
                        label: '‚ö° EV',
                        data: d.fluxoEV,
                        backgroundColor: 'rgba(16,185,129,0.8)',
                        borderColor: 'rgb(16,185,129)',
                        borderWidth: 1
                    },
                    {
                        label: 'üöó ICE',
                        data: d.fluxoICE,
                        backgroundColor: 'rgba(239,68,68,0.8)',
                        borderColor: 'rgb(239,68,68)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: true, aspectRatio: 2,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {color: '#fff', font: {size: 9}, boxWidth: 10, padding: 5}
                    },
                    tooltip: {callbacks: {label: c => c.dataset.label + ': ' + moneyBR(c.parsed.y)}}
                },
                scales: {
                    x: {ticks: {color: '#fff', font: {size: 8}, maxRotation: 0}, grid: {display: false}},
                    y: {
                        ticks: {color: '#fff', font: {size: 8}, callback: v => 'R$ ' + (v / 1000).toFixed(0) + 'k'},
                        grid: {color: 'rgba(255,255,255,0.1)'}
                    }
                }
            }
        });

        // S√©rie VPL (usa mesma f√≥rmula do card: d.vplSerieEV/ICE)
        const ctxPayback = document.getElementById('canvasPayback').getContext('2d');
        if (chartPayback) chartPayback.destroy();
        chartPayback = new Chart(ctxPayback, {
            type: 'line',
            data: {
                labels, datasets: [
                    {
                        label: 'VPL EV',
                        data: d.vplSerieEV,
                        borderColor: 'rgb(16,185,129)',
                        backgroundColor: 'rgba(16,185,129,0.1)',
                        borderWidth: 2,
                        tension: 0.3
                    },
                    {
                        label: 'VPL ICE',
                        data: d.vplSerieICE,
                        borderColor: 'rgb(239,68,68)',
                        backgroundColor: 'rgba(239,68,68,0.1)',
                        borderWidth: 2,
                        tension: 0.3
                    }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: true, aspectRatio: 2,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {color: '#fff', font: {size: 9}, boxWidth: 10, padding: 5}
                    },
                    tooltip: {
                        callbacks: {
                            label: c => c.dataset.label + ': ' + moneyBR(c.parsed.y),
                            footer: (ctx) => !isNaN(d.payback) && ctx[0].dataIndex <= Math.ceil(d.payback) ? `\nPayback em ${formatPayback(d.payback)}` : ''
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: {color: '#fff', font: {size: 8}, maxRotation: 0},
                        grid: {color: 'rgba(255,255,255,0.1)'}
                    },
                    y: {
                        ticks: {color: '#fff', font: {size: 8}, callback: v => 'R$ ' + (v / 1000).toFixed(0) + 'k'},
                        grid: {color: 'rgba(255,255,255,0.1)'}
                    }
                }
            }
        });

// ====== GR√ÅFICO 3 - CUSTOS COMPARATIVOS (DUAS ESCALAS MELHOR VIS√çVEIS) ======
        const ctxCustoKm = document.getElementById('canvasCustoKm').getContext('2d');
        if (chartCustoKm) chartCustoKm.destroy();

// c√°lculos
        const custoTotalEV = d.custoAnualEV * d.anos + d.precoEV - (d.precoEV * d.resPctEV);
        const custoTotalICE = d.custoAnualICE * d.anos + d.precoICE - (d.precoICE * d.resPctICE);
        const diffTotal = ((custoTotalICE - custoTotalEV) / custoTotalICE * 100).toFixed(1);

// labels e valores
        const labels3 = ['‚ö° EV', '‚õΩ ICE'];
        const datasetKm = [d.custoKmEV, d.custoKmICE];
        const datasetAnual = [d.custoAnualEV, d.custoAnualICE];
        const datasetTotal = [custoTotalEV, custoTotalICE];

// gr√°fico com eixos duplos e alto contraste
        chartCustoKm = new Chart(ctxCustoKm, {
            type: 'bar',
            data: {
                labels: labels3,
                datasets: [
                    {
                        label: 'üí∞ Custo por km (Eixo Esquerdo)',
                        data: datasetKm,
                        backgroundColor: 'rgba(255,255,255,0.8)',
                        borderColor: '#ffffff',
                        borderWidth: 1.5,
                        yAxisID: 'yKm'
                    },
                    {
                        label: 'üìÜ Custo Anual (Eixo Direito)',
                        data: datasetAnual,
                        backgroundColor: 'rgba(59,130,246,0.8)',
                        borderColor: 'rgb(37,99,235)',
                        borderWidth: 1.5,
                        yAxisID: 'yReais'
                    },
                    {
                        label: 'üßæ Custo Total (Eixo Direito)',
                        data: datasetTotal,
                        backgroundColor: 'rgba(234,179,8,0.85)',
                        borderColor: 'rgb(202,138,4)',
                        borderWidth: 1.5,
                        yAxisID: 'yReais'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 2,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: '#fff',
                            font: { size: 9, weight: 'bold' },
                            padding: 10
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: ctx => {
                                const label = ctx.dataset.label || '';
                                const val = ctx.parsed.y;
                                if (ctx.dataset.yAxisID === 'yKm') {
                                    return `${label}: ${moneyBR4(val)} /km`;
                                } else {
                                    return `${label}: ${moneyBR(val)}`;
                                }
                            }
                        }
                    },
                    title: {
                        display: true,
                        text: `EV √© ${diffTotal}% mais barato no custo total`,
                        color: '#fff',
                        font: { size: 10, weight: 'bold' }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: '#fff', font: { size: 9, weight: 'bold' } },
                        grid: { display: false }
                    },
                    yKm: {
                        position: 'left',
                        title: {
                            display: true,
                            text: 'üí∞ R$/km (Escala Esquerda)',
                            color: '#ffffff',
                            font: { size: 10, weight: 'bold' }
                        },
                        ticks: {
                            color: '#ffffff',
                            font: { size: 9, weight: '600' },
                            callback: v => 'R$ ' + v.toFixed(3)
                        },
                        grid: { color: 'rgba(255,255,255,0.2)', lineWidth: 0.5 }
                    },
                    yReais: {
                        position: 'right',
                        title: {
                            display: true,
                            text: 'üìÜ / üßæ Custos (R$) ‚Äî Escala Direita',
                            color: '#93c5fd',
                            font: { size: 10, weight: 'bold' }
                        },
                        ticks: {
                            color: '#93c5fd',
                            font: { size: 9, weight: '600' },
                            callback: v => 'R$ ' + (v / 1000).toFixed(0) + 'k'
                        },
                        grid: { drawOnChartArea: false }
                    }
                }
            }
        });


    }
    /* =================== PIPE DE C√ÅLCULO =================== */
    function calcular(){
        if(!selecionadoEV||!selecionadoICE){alert("Selecione os dois modelos (El√©trico e Combust√£o).");return;}
        if(!selecionadoPerfil||!selecionadoCenario){alert("Selecione um perfil e um cen√°rio.");return;}

        const tarifaRes=toNumBR(document.getElementById('tarifaRes').value);
        const tarifaPub=toNumBR(document.getElementById('tarifaPub').value);
        const precoGas=toNumBR(document.getElementById('precoGas').value);
        const kmAno=toNumBR(selecionadoPerfil.km_ano);
        const pctPub=toNumBR(selecionadoPerfil['%_recarga_publica']);
        const pctRodovia=toNumBR(selecionadoPerfil['%_rodovia']);

        const tma_in=document.getElementById('tma').value.trim();
        let tma = tma_in==="" ? toNumBR(selecionadoCenario.tma) : toNumBR(tma_in)/100;
        if(tma<=0||isNaN(tma)){alert("‚ö†Ô∏è TMA inv√°lida! Informe um valor > 0.");return;}

        const anos_in=document.getElementById('anos').value.trim();
        const anos= anos_in==="" ? toNumBR(selecionadoCenario.periodo) : toNumBR(anos_in);

        const preco_ev_in=document.getElementById('precoEV').value.trim();
        const preco_ice_in=document.getElementById('precoICE').value.trim();
        const preco_ev = preco_ev_in==="" ? toNumBR(selecionadoEV.preco_inicial) : toNumBR(preco_ev_in);
        const preco_ice= preco_ice_in===""? toNumBR(selecionadoICE.preco_inicial): toNumBR(preco_ice_in);

        const cuEV=toNumBR(selecionadoEV.consumo_urb), crEV=toNumBR(selecionadoEV.consumo_rod);
        const cuICE=toNumBR(selecionadoICE.consumo_urb), crICE=toNumBR(selecionadoICE.consumo_rod);

        const consumoMedioEV=(cuEV*(1-pctRodovia))+(crEV*pctRodovia);
        const consumoMedioICE=(cuICE*(1-pctRodovia))+(crICE*pctRodovia);

        const custoEnergiaEV=((1-pctPub)*tarifaRes)+(pctPub*tarifaPub);
        const custoKmEV=consumoMedioEV>0?(custoEnergiaEV/consumoMedioEV):0;
        const custoKmICE=consumoMedioICE>0?(precoGas/consumoMedioICE):0;

        const custoAnualEV= toNumBR(selecionadoEV.manutencao_anual)
            + toNumBR(selecionadoEV.seguro_anual)
            + toNumBR(selecionadoEV.ipva_anual)
            + toNumBR(selecionadoEV.pneus_ano)
            + (custoKmEV*kmAno);

        const custoAnualICE=toNumBR(selecionadoICE.manutencao_anual)
            + toNumBR(selecionadoICE.seguro_anual)
            + toNumBR(selecionadoICE.ipva_anual)
            + toNumBR(selecionadoICE.pneus_ano)
            + (custoKmICE*kmAno);

        const resPctEV=toNumBR(selecionadoEV['residual_%']);
        const resPctICE=toNumBR(selecionadoICE['residual_%']);

        const fator=(((1+tma)**anos-1)/(tma*((1+tma)**anos)));
        const vplEV = -preco_ev - (custoAnualEV*fator) + ((preco_ev*resPctEV)/((1+tma)**anos));
        const vplICE= -preco_ice- (custoAnualICE*fator)+ ((preco_ice*resPctICE)/((1+tma)**anos));

        const fluxoEV=gerarFluxoVeiculo(preco_ev,custoAnualEV,resPctEV,anos);
        const fluxoICE=gerarFluxoVeiculo(preco_ice,custoAnualICE,resPctICE,anos);
        const tirEV=calcularTIR(fluxoEV);
        const tirICE=calcularTIR(fluxoICE);

        const payback=calcularPaybackDescontado(preco_ev,custoAnualEV,resPctEV,preco_ice,custoAnualICE,resPctICE,tma);
        let paybackFinal = payback;
        if (isNaN(payback) || payback > anos) {
            paybackFinal = NaN; // for√ßa "Sem payback" no card
        }
        // preencher s√©ries de VPL por per√≠odo (gr√°fico)
        const serieEV = construirSerieVPL(preco_ev,custoAnualEV,resPctEV,tma,anos);
        const serieICE= construirSerieVPL(preco_ice,custoAnualICE,resPctICE,tma,anos);

        // atualizar estado √∫nico
        Object.assign(dadosAtuais,{
            tma, anos,
            precoEV:preco_ev, precoICE:preco_ice,
            custoAnualEV, custoAnualICE, resPctEV, resPctICE,
            fluxoEV, fluxoICE,
            vplEV, vplICE, tirEV, tirICE, payback: paybackFinal,
            vplSerieEV:serieEV, vplSerieICE:serieICE,
            custoKmEV, custoKmICE
        });

        // DOM + gr√°ficos
        aplicarResultadosDOM();
        desenharGraficos();
    }

    /* =================== INIT =================== */
    async function init(){
        [dataVeiculos,dataPerfis,dataCenarios]=await Promise.all([getCSV(URLS.VEICULOS),getCSV(URLS.PERFIS),getCSV(URLS.CENARIOS)]);
        popularVeiculos(); popularPerfis(); popularCenarios();

        document.getElementById('selEV').addEventListener('change',e=>{
            const m=e.target.value; selecionadoEV=dataVeiculos.find(v=>v.modelo===m);
            setInfoVeiculo(selecionadoEV,'infoEV','precoEV','imgEV',true);
        });
        document.getElementById('selICE').addEventListener('change',e=>{
            const m=e.target.value; selecionadoICE=dataVeiculos.find(v=>v.modelo===m);
            setInfoVeiculo(selecionadoICE,'infoICE','precoICE','imgICE',false);
        });
        document.getElementById('btnCalcular').addEventListener('click',calcular);
    }
    init().catch(err=>{
        console.error(err);
        alert('Erro ao carregar dados: '+err);
        document.getElementById('btnCalcular').addEventListener('click',calcular);
    });

    /* =================== REGRAS DE DIGITA√á√ÉO (com alertas e corre√ß√µes autom√°ticas) =================== */
    function bloquearEntradaInvalida() {
        const inputs = document.querySelectorAll('input');
        inputs.forEach(inp => {
            inp.addEventListener('keydown', e => {
                const permitido = ['Backspace','Delete','ArrowLeft','ArrowRight','Tab'];
                const key = e.key;

// Bloquear letras e caracteres especiais
                if (/[^0-9,]/.test(key) && !permitido.includes(key)) {
                    e.preventDefault();
                    if (/[a-zA-Z]/.test(key)) alert("‚ö†Ô∏è Digite apenas n√∫meros e v√≠rgula (,) ‚Äî letras n√£o s√£o permitidas.");
                    else if (key === '.') alert("‚ö†Ô∏è Use v√≠rgula (,) em vez de ponto (.) para decimais.");
                    else if (/[^0-9,]/.test(key)) alert("‚ö†Ô∏è Caracteres especiais n√£o s√£o permitidos.");
                    return;
                }

// Impedir duas v√≠rgulas
                if (key === ',' && inp.value.includes(',')) {
                    e.preventDefault();
                    return;
                }
            });

// Corrigir automaticamente entradas ap√≥s colar ou digitar
            inp.addEventListener('input', e => {
                let v = e.target.value;

// remove caracteres inv√°lidos
                if (/[a-zA-Z!@#$%^&*()_+\-={}\[\]:;"'<>,.?/\\|`~]/.test(v)) {
                    alert("‚ö†Ô∏è Digite apenas n√∫meros e v√≠rgula (,) ‚Äî caracteres especiais n√£o s√£o permitidos.");
                }

                v = v.replace(/[^0-9,]/g, ''); // mant√©m s√≥ n√∫meros e v√≠rgula
                const partes = v.split(',');
                if (partes.length > 2) v = partes[0] + ',' + partes[1]; // limita 1 v√≠rgula
                if (v.startsWith(',')) v = '0' + v; // se come√ßar com v√≠rgula, vira 0,5 etc.
                if (v === ',') v = '0,'; // se for apenas v√≠rgula, prefixa 0
                if (v === '') v = ''; // mant√©m vazio se apagar tudo

                e.target.value = v;
            });
        });
    }

    document.addEventListener('DOMContentLoaded', bloquearEntradaInvalida);
</script>
</body>
</html>
