<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard EV vs ICE</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        /* ================================================================ */
        /* ==================== ESTILOS (INTOCADOS) ===================== */
        /* ================================================================ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 8px; color: #333; overflow: hidden; height: 100vh; }
        .container { max-width: 100%; height: calc(100vh - 16px); display: flex; flex-direction: column; gap: 6px; }
        .header { background: white; padding: 8px 20px; border-radius: 8px; box-shadow: 0 3px 15px rgba(0,0,0,0.2); display: flex; justify-content: space-between; align-items: center; }
        .header h1 { color: #667eea; font-size: 1.3em; }
        .status { font-size: 0.75em; color: #666; }
        .status.connected { color: #10b981; font-weight: bold; }
        .status.error { color: #ef4444; font-weight: bold; }
        .inputs-wrapper { background: white; padding: 10px; border-radius: 8px; box-shadow: 0 3px 15px rgba(0,0,0,0.2); }
        .inputs-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; }
        .input-card { background: #f8f9fa; border: 2px solid #e0e0e0; border-radius: 8px; padding: 10px; display: flex; flex-direction: column; }
        .input-card h3 { color: #667eea; font-size: 0.9em; margin-bottom: 8px; padding-bottom: 5px; border-bottom: 2px solid #667eea; }
        .form-group { margin-bottom: 6px; }
        .form-group label { display: block; font-size: 0.7em; font-weight: 600; color: #555; margin-bottom: 3px; }
        .form-group select, .form-group input { width: 100%; padding: 5px 7px; border: 2px solid #ddd; border-radius: 5px; font-size: 0.75em; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #667eea; }
        .vehicle-info { background: white; padding: 5px; border-radius: 4px; font-size: 0.65em; margin-top: 3px; color: #666; line-height: 1.3; min-height: 32px; }
        .profile-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-bottom: 6px; }
        .profile-btn { padding: 6px; border: 2px solid #ddd; background: white; border-radius: 6px; cursor: pointer; text-align: center; font-size: 0.65em; transition: all 0.2s; }
        .profile-btn:hover { border-color: #667eea; transform: scale(1.02); }
        .profile-btn.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-color: #667eea; font-weight: bold; }
        .profile-btn div { font-weight: bold; margin-bottom: 1px; }
        .scenario-grid { display: flex; gap: 5px; margin-bottom: 6px; }
        .scenario-btn { flex: 1; padding: 6px; border: 2px solid #ddd; background: white; border-radius: 5px; cursor: pointer; font-size: 0.7em; font-weight: 600; transition: all 0.2s; }
        .scenario-btn:hover { border-color: #667eea; }
        .scenario-btn.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
        .btn-calculate { width: 100%; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 10px; border: none; border-radius: 6px; font-weight: bold; font-size: 0.85em; cursor: pointer; margin-top: auto; }
        .btn-calculate:hover { opacity: 0.9; }
        .results-wrapper { background: white; padding: 10px; border-radius: 8px; box-shadow: 0 3px 15px rgba(0,0,0,0.2); flex: 1; min-height: 0; display: flex; flex-direction: column; gap: 8px; overflow: hidden; }
        .metrics-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; }
        .metric-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 8px; border-radius: 8px; text-align: center; }
        .metric-card h4 { font-size: 0.65em; opacity: 0.9; margin-bottom: 4px; }
        .metric-card .value { font-size: 1.2em; font-weight: bold; margin-bottom: 1px; }
        .metric-card .label { font-size: 0.6em; opacity: 0.8; }
        .content-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 8px; flex: 1; min-height: 0; }
        .charts-grid { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 8px; min-height: 0; }
        .chart-card { background: #f8f9fa; border: 2px solid #e0e0e0; border-radius: 8px; padding: 8px; display: flex; flex-direction: column; min-height: 0; }
        .chart-card h4 { color: #667eea; font-size: 0.8em; margin-bottom: 5px; }
        .chart-container { position: relative; flex: 1; min-height: 0; }
        .right-panel { display: flex; flex-direction: column; gap: 8px; min-height: 0; }
        .conclusion-card { background: #f8f9fa; border: 2px solid #e0e0e0; border-left: 4px solid #667eea; border-radius: 8px; padding: 10px; }
        .conclusion-card h3 { color: #667eea; font-size: 0.85em; margin-bottom: 6px; }
        .conclusion-card p { font-size: 0.7em; line-height: 1.5; color: #555; }
        .table-card { background: #f8f9fa; border: 2px solid #e0e0e0; border-radius: 8px; padding: 8px; flex: 1; overflow-y: auto; min-height: 0; }
        .table-card h4 { color: #667eea; font-size: 0.8em; margin-bottom: 6px; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 0.7em; }
        .data-table th { background: #667eea; color: white; padding: 5px; text-align: left; font-size: 0.9em; }
        .data-table td { padding: 4px 5px; border-bottom: 1px solid #ddd; }
        .data-table tr:nth-child(even) { background: white; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚ö° An√°lise Econ√¥mica: EV vs ICE</h1>
            <div class="status" id="connectionStatus">üîÑ Carregando...</div>
        </div>
        
        <div class="inputs-wrapper">
            <div class="inputs-grid">
                <div class="input-card">
                    <h3>‚ö° Ve√≠culo El√©trico</h3>
                    <div class="form-group">
                        <label>Modelo:</label>
                        <select id="ev_select" onchange="loadEV()">
                            <option value="">Carregando...</option>
                        </select>
                        <div class="vehicle-info" id="ev_info">Selecione um ve√≠culo</div>
                    </div>
                    <div class="form-group">
                        <label>üí∞ Pre√ßo (R$):</label>
                        <input type="number" id="ev_preco" value="0" step="1000">
                    </div>
                </div>
                
                <div class="input-card">
                    <h3>üöó Ve√≠culo Combust√£o</h3>
                    <div class="form-group">
                        <label>Modelo:</label>
                        <select id="ice_select" onchange="loadICE()">
                            <option value="">Carregando...</option>
                        </select>
                        <div class="vehicle-info" id="ice_info">Selecione um ve√≠culo</div>
                    </div>
                    <div class="form-group">
                        <label>üí∞ Pre√ßo (R$):</label>
                        <input type="number" id="ice_preco" value="0" step="1000">
                    </div>
                </div>
                
                <div class="input-card">
                    <h3>üë§ Perfil & üí∞ Custos</h3>
                    <div class="profile-grid">
                        <div class="profile-btn active" onclick="selectProfile(event, 'leve')">
                            <div>üè† Leve</div>
                            <small>6k km/ano</small>
                        </div>
                        <div class="profile-btn" onclick="selectProfile(event, 'pesado')">
                            <div>üöô Pesado</div>
                            <small>15k km/ano</small>
                        </div>
                        <div class="profile-btn" onclick="selectProfile(event, 'app')">
                            <div>üì± App</div>
                            <small>60k km/ano</small>
                        </div>
                        <div class="profile-btn" onclick="selectProfile(event, 'viajante')">
                            <div>‚úàÔ∏è Viajante</div>
                            <small>28k km/ano</small>
                        </div>
                    </div>
                    
                    <div class="input-row">
                        <div class="form-group">
                            <label>Tarifa Res. (R$/kWh):</label>
                            <input type="number" id="tarifa_res" value="0.65" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Tarifa P√∫b. (R$/kWh):</label>
                            <input type="number" id="tarifa_pub" value="1.80" step="0.10">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Gasolina (R$/L):</label>
                        <input type="number" id="preco_gasolina" value="5.80" step="0.10">
                    </div>
                </div>
                
                <div class="input-card">
                    <h3>üéØ Cen√°rio</h3>
                    <div class="scenario-grid">
                        <button class="scenario-btn" onclick="selectScenario(event, 'otimista')">üìà Otim</button>
                        <button class="scenario-btn active" onclick="selectScenario(event, 'base')">üìä Base</button>
                        <button class="scenario-btn" onclick="selectScenario(event, 'pessimista')">üìâ Pess</button>
                    </div>
                    
                    <div class="input-row">
                        <div class="form-group">
                            <label>Per√≠odo (anos):</label>
                            <input type="number" id="periodo" value="5" step="1" min="1" max="10">
                        </div>
                        <div class="form-group">
                            <label>TMA (%):</label>
                            <input type="number" id="tma" value="10" step="0.5">
                        </div>
                    </div>
                    
                    <button class="btn-calculate" onclick="calcular()">üöÄ CALCULAR</button>
                </div>
            </div>
        </div>
        
        <div class="results-wrapper">
            <div class="metrics-grid">
                <div class="metric-card">
                    <h4>VPL DIFERENCIAL</h4>
                    <div class="value" id="vpl_result">-</div>
                    <div class="label">ICE - EV</div>
                </div>
                <div class="metric-card">
                    <h4>TIR</h4>
                    <div class="value" id="tir_result">-</div>
                    <div class="label">%</div>
                </div>
                <div class="metric-card">
                    <h4>PAYBACK</h4>
                    <div class="value" id="payback_result">-</div>
                    <div class="label">anos</div>
                </div>
                <div class="metric-card">
                    <h4>R$/KM EV</h4>
                    <div class="value" id="custo_km_ev">-</div>
                    <div class="label">custo</div>
                </div>
                <div class="metric-card">
                    <h4>R$/KM ICE</h4>
                    <div class="value" id="custo_km_ice">-</div>
                    <div class="label">custo</div>
                </div>
                <div class="metric-card">
                    <h4>ECONOMIA</h4>
                    <div class="value" id="economia_total">-</div>
                    <div class="label">total</div>
                </div>
            </div>
            
            <div class="content-grid">
                <div class="charts-grid">
                    <div class="chart-card">
                        <h4>üìä Custo Acumulado</h4>
                        <div class="chart-container">
                            <canvas id="chartCustoAcumulado"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-card">
                        <h4>üí∞ Composi√ß√£o</h4>
                        <div class="chart-container">
                            <canvas id="chartComposicao"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-card">
                        <h4>üìà Fluxo de Caixa</h4>
                        <div class="chart-container">
                            <canvas id="chartFluxoCaixa"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-card">
                        <h4>üéØ Por Perfil</h4>
                        <div class="chart-container">
                            <canvas id="chartPerfis"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="right-panel">
                    <div class="conclusion-card">
                        <h3>üí° Conclus√£o</h3>
                        <p id="conclusao_texto">Calcule para ver a conclus√£o</p>
                    </div>
                    
                    <div class="table-card">
                        <h4>üìã Detalhamento</h4>
                        <div id="detalhamento">Calcule para ver os detalhes</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        /* ================================================================ */
        /* ================== JAVASCRIPT (REESCRITO) ==================== */
        /* ================================================================ */

        // --- Configura√ß√£o ---
        const GOOGLE_SHEETS_CONFIG = {
            SHEET_ID: '1WbsZp2pRYLh6AzEz12xmKdAw2doKRA_9A_DipgbGG2A',
            ABAS: {
                VEICULOS_EV: 'VEICULOS_EV',
                VEICULOS_ICE: 'VEICULOS_ICE',
                PERFIS: 'PERFIS',
                CENARIOS: 'CENARIOS'
            }
        };

        // --- Vari√°veis Globais de Dados ---
        let db = {
            ev: {},      // Armazenar√° os dados dos ve√≠culos EV (chave: ID)
            ice: {},     // Armazenar√° os dados dos ve√≠culos ICE (chave: ID)
            profiles: {},// Armazenar√° os dados dos perfis (chave: nome do perfil em min√∫sculo)
            scenarios: {} // Armazenar√° os dados dos cen√°rios (chave: nome do cen√°rio em min√∫sculo)
        };

        // --- Estado da Aplica√ß√£o ---
        let currentProfile = 'leve';
        let currentScenario = 'base';
        let currentEV = null;
        let currentICE = null;
        let charts = {}; // Armazena inst√¢ncias dos gr√°ficos Chart.js

        // --- Fun√ß√£o Auxiliar para URL (com cache-busting) ---
        const getSheetURL = (aba) => {
            const timestamp = new Date().getTime(); // Par√¢metro √∫nico para evitar cache
            return `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEETS_CONFIG.SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(aba)}&t=${timestamp}`;
        };

        // --- Fun√ß√£o Principal de Busca e Processamento ---
        async function loadAndProcessSheetData(aba, processFunction) {
            console.log(`[loadAndProcessSheetData] Iniciando para: ${aba}`);
            try {
                const url = getSheetURL(aba);
                const response = await fetch(url);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const text = await response.text();
                const jsonTextMatch = text.match(/google\.visualization\.Query\.setResponse\((.*)\);?$/s);

                if (!jsonTextMatch) {
                    console.error(`[loadAndProcessSheetData] Resposta de ${aba} n√£o parece ser JSON:`, text.substring(0, 500));
                    throw new Error('Formato de resposta inv√°lido');
                }

                const json = JSON.parse(jsonTextMatch[1]);

                if (json.status === 'error') {
                    throw new Error(`Erro retornado pelo Google Sheets: ${json.errors[0].detailed_message}`);
                }

                if (!json.table || !json.table.rows || json.table.rows.length === 0 || !json.table.rows[0].c) {
                    throw new Error('Dados da tabela inv√°lidos ou vazios');
                }

                const headers = json.table.rows[0].c.map((cell, i) => cell ? cell.v : `Col${i}`);
                const dataRows = [];

                for (let i = 1; i < json.table.rows.length; i++) {
                    const rowObject = json.table.rows[i];
                    if (!rowObject || !rowObject.c) continue; // Pula linhas vazias

                    const rowData = {};
                    let hasIdentifier = false; // Verifica se a linha tem um ID, Perfil ou Cenario
                    headers.forEach((header, index) => {
                        rowData[header] = rowObject.c[index] ? rowObject.c[index].v : null;
                        if ((header === 'ID' || header === 'Perfil' || header === 'Cenario') && rowData[header]) {
                            hasIdentifier = true;
                        }
                    });
                    
                    if (hasIdentifier) { // S√≥ adiciona se tiver um identificador
                       dataRows.push(rowData);
                    }
                }
                
                console.log(`[loadAndProcessSheetData] ${dataRows.length} linhas de dados encontradas para ${aba}`);
                
                // Chama a fun√ß√£o de processamento espec√≠fica
                processFunction(dataRows);
                
                console.log(`[loadAndProcessSheetData] Processamento conclu√≠do para: ${aba}`);
                return true; // Indica sucesso

            } catch (error) {
                console.error(`[loadAndProcessSheetData] ERRO FATAL ao carregar ${aba}:`, error.message);
                throw error; // Repassa o erro para o Promise.all
            }
        }

        // --- Fun√ß√µes de Processamento Espec√≠ficas ---
        function processEvData(dataRows) {
            db.ev = {}; // Limpa dados anteriores
            dataRows.forEach(row => {
                if (!row.ID) return;
                db.ev[row.ID] = {
                    id: row.ID,
                    nome: row.Modelo,
                    preco: parseFloat(row.Preco) || 0,
                    consumoUrb: parseFloat(row.Cons_Urb) || 0,
                    consumoRod: parseFloat(row.Cons_Rod) || 0,
                    residual: parseFloat(row.Residual) || 0,
                    manutencao: parseFloat(row.Manutencao) || 0,
                    seguro: parseFloat(row.Seguro) || 0,
                    ipva: parseFloat(row.IPVA) || 0
                };
            });
            console.log(`[processEvData] EVs carregados:`, Object.keys(db.ev).length);
        }

        function processIceData(dataRows) {
            db.ice = {}; // Limpa dados anteriores
            dataRows.forEach(row => {
                if (!row.ID) return;
                db.ice[row.ID] = {
                     id: row.ID,
                    nome: row.Modelo,
                    preco: parseFloat(row.Preco) || 0,
                    consumoUrb: parseFloat(row.Cons_Urb) || 0,
                    consumoRod: parseFloat(row.Cons_Rod) || 0,
                    residual: parseFloat(row.Residual) || 0,
                    manutencao: parseFloat(row.Manutencao) || 0,
                    seguro: parseFloat(row.Seguro) || 0,
                    ipva: parseFloat(row.IPVA) || 0
                };
            });
             console.log(`[processIceData] ICEs carregados:`, Object.keys(db.ice).length);
        }

        function processProfileData(dataRows) {
            db.profiles = {}; // Limpa dados anteriores
            dataRows.forEach(row => {
                const profileName = row.Perfil ? row.Perfil.toLowerCase() : null;
                if (!profileName) return;
                db.profiles[profileName] = {
                    km: parseFloat(row.KM_Ano) || 0,
                    urbano: parseFloat(row.Prop_Urbano) * 100 || 0, // Convertido para %
                    recargaRes: parseFloat(row.Recarga_Res) * 100 || 0 // Convertido para %
                };
            });
            console.log(`[processProfileData] Perfis carregados:`, Object.keys(db.profiles).length);
        }

        function processScenarioData(dataRows) {
            db.scenarios = {}; // Limpa dados anteriores
            dataRows.forEach(row => {
                const scenarioName = row.Cenario ? row.Cenario.toLowerCase() : null;
                 if (!scenarioName) return;
                 db.scenarios[scenarioName] = {
                    gasolina: parseFloat(row.Gasolina) || 0,
                    tarifaRes: parseFloat(row.Tarifa_Res) || 0,
                    tarifaPub: parseFloat(row.Tarifa_Pub) || 0
                 };
            });
            console.log(`[processScenarioData] Cen√°rios carregados:`, Object.keys(db.scenarios).length);
        }

        // --- Fun√ß√£o de Inicializa√ß√£o Principal (Nova) ---
        async function initializeDashboard_freshStart() {
            const statusElement = document.getElementById('connectionStatus');
            statusElement.textContent = 'üîÑ Carregando dados...';
            console.log('=== INICIANDO DASHBOARD (FRESH START) ===');

            try {
                // Carrega todos os dados em paralelo, cada um com sua fun√ß√£o de processamento
                await Promise.all([
                    loadAndProcessSheetData(GOOGLE_SHEETS_CONFIG.ABAS.VEICULOS_EV, processEvData),
                    loadAndProcessSheetData(GOOGLE_SHEETS_CONFIG.ABAS.VEICULOS_ICE, processIceData),
                    loadAndProcessSheetData(GOOGLE_SHEETS_CONFIG.ABAS.PERFIS, processProfileData),
                    loadAndProcessSheetData(GOOGLE_SHEETS_CONFIG.ABAS.CENARIOS, processScenarioData)
                ]);

                // Verifica se os dados essenciais foram carregados
                if (Object.keys(db.ev).length === 0) {
                    throw new Error('Nenhum ve√≠culo EV foi carregado ap√≥s processamento.');
                }
                 if (Object.keys(db.ice).length === 0) {
                    throw new Error('Nenhum ve√≠culo ICE foi carregado ap√≥s processamento.');
                }
                 if (Object.keys(db.profiles).length === 0) {
                    throw new Error('Nenhum Perfil foi carregado ap√≥s processamento.');
                }
                 if (Object.keys(db.scenarios).length === 0) {
                    throw new Error('Nenhum Cen√°rio foi carregado ap√≥s processamento.');
                }

                console.log('üöÄ Sucesso! Todos os dados carregados e processados.');
                populateDropdowns();
                statusElement.textContent = '‚úÖ Conectado';
                statusElement.classList.add('connected');
                statusElement.classList.remove('error');

            } catch (error) {
                console.error('‚ùå ERRO FATAL na inicializa√ß√£o:', error);
                statusElement.textContent = `‚ö†Ô∏è Erro na inicializa√ß√£o: ${error.message}`;
                statusElement.classList.add('error');
                statusElement.classList.remove('connected');
            }
        }

        // --- Fun√ß√µes da Interface (Mantidas, mas usando 'db') ---
        function populateDropdowns() {
            console.log('[populateDropdowns] Iniciando...');
            const evSelect = document.getElementById('ev_select');
            const iceSelect = document.getElementById('ice_select');

            evSelect.innerHTML = '<option value="">Selecione EV</option>';
            Object.keys(db.ev).forEach(id => {
                const v = db.ev[id];
                evSelect.innerHTML += `<option value="${id}">${v.nome}</option>`;
            });

            iceSelect.innerHTML = '<option value="">Selecione ICE</option>';
            Object.keys(db.ice).forEach(id => {
                const v = db.ice[id];
                iceSelect.innerHTML += `<option value="${id}">${v.nome}</option>`;
            });
            console.log('[populateDropdowns] Conclu√≠do.');
        }

        function loadEV() {
            const select = document.getElementById('ev_select');
            const id = select.value;
            if (!id || !db.ev[id]) {
                 currentEV = null;
                 document.getElementById('ev_info').innerHTML = 'Selecione um ve√≠culo';
                 document.getElementById('ev_preco').value = 0;
                 return;
            }
            currentEV = db.ev[id];
            document.getElementById('ev_preco').value = currentEV.preco;
            document.getElementById('ev_info').innerHTML = `
                üí° ${currentEV.consumoUrb} kWh/100km (urb) | ${currentEV.consumoRod} kWh/100km (rod)<br>
                üí∞ Seg: ${formatMoney(currentEV.seguro)} | Man: ${formatMoney(currentEV.manutencao)}/ano
            `;
        }

        function loadICE() {
            const select = document.getElementById('ice_select');
            const id = select.value;
             if (!id || !db.ice[id]) {
                 currentICE = null;
                 document.getElementById('ice_info').innerHTML = 'Selecione um ve√≠culo';
                 document.getElementById('ice_preco').value = 0;
                 return;
            }
            currentICE = db.ice[id];
            document.getElementById('ice_preco').value = currentICE.preco;
            document.getElementById('ice_info').innerHTML = `
                ‚õΩ ${currentICE.consumoUrb} km/L (urb) | ${currentICE.consumoRod} km/L (rod)<br>
                üí∞ Seg: ${formatMoney(currentICE.seguro)} | Man: ${formatMoney(currentICE.manutencao)}/ano
            `;
        }

        function selectProfile(event, profile) {
            currentProfile = profile;
            document.querySelectorAll('.profile-btn').forEach(btn => btn.classList.remove('active'));
            event.target.closest('.profile-btn').classList.add('active');
        }

        function selectScenario(event, scenario) {
            currentScenario = scenario;
            document.querySelectorAll('.scenario-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            if (db.scenarios[scenario]) {
                document.getElementById('preco_gasolina').value = db.scenarios[scenario].gasolina;
                document.getElementById('tarifa_res').value = db.scenarios[scenario].tarifaRes;
                document.getElementById('tarifa_pub').value = db.scenarios[scenario].tarifaPub;
            }
        }

        function calcular() {
            if (!currentEV || !currentICE) {
                alert('Selecione ambos os ve√≠culos!');
                return;
            }
            
            const perfil = db.profiles[currentProfile];
            if (!perfil) {
                alert('Perfil selecionado inv√°lido ou n√£o carregado!');
                return;
            }

            const periodo = parseInt(document.getElementById('periodo').value);
            const tma = parseFloat(document.getElementById('tma').value) / 100;
            const tarifaRes = parseFloat(document.getElementById('tarifa_res').value);
            const tarifaPub = parseFloat(document.getElementById('tarifa_pub').value);
            const precoGasolina = parseFloat(document.getElementById('preco_gasolina').value);
            
            // --- C√°lculos (sem altera√ß√µes l√≥gicas) ---
            const kmAnual = perfil.km;
            const kmUrb = kmAnual * (perfil.urbano / 100);
            const kmRod = kmAnual * (1 - perfil.urbano / 100);
            
            const consumoTotalEV_kWh = (kmUrb * currentEV.consumoUrb / 100) + (kmRod * currentEV.consumoRod / 100);
            const custoEnergiaRes = consumoTotalEV_kWh * (perfil.recargaRes / 100) * tarifaRes;
            const custoEnergiaPub = consumoTotalEV_kWh * (1 - perfil.recargaRes / 100) * tarifaPub;
            const custoEnergiaEVAnual = custoEnergiaRes + custoEnergiaPub;
            const custoOperacionalEVAnual = custoEnergiaEVAnual + currentEV.manutencao + currentEV.seguro + currentEV.ipva;
            const custoKmEV = kmAnual > 0 ? custoOperacionalEVAnual / kmAnual : 0;
            
            const consumoTotalICE_L = (kmUrb / currentICE.consumoUrb) + (kmRod / currentICE.consumoRod);
            const custoCombustivelAnual = consumoTotalICE_L * precoGasolina;
            const custoOperacionalICEAnual = custoCombustivelAnual + currentICE.manutencao + currentICE.seguro + currentICE.ipva;
            const custoKmICE = kmAnual > 0 ? custoOperacionalICEAnual / kmAnual : 0;

            // Fluxo de caixa
            const fluxoEV = [-currentEV.preco];
            const fluxoICE = [-currentICE.preco];
            for (let ano = 1; ano <= periodo; ano++) {
                fluxoEV.push(-custoOperacionalEVAnual);
                fluxoICE.push(-custoOperacionalICEAnual);
            }
            fluxoEV[periodo] += currentEV.preco * (currentEV.residual / 100); // Valor residual no final
            fluxoICE[periodo] += currentICE.preco * (currentICE.residual / 100); // Valor residual no final

            // Indicadores Financeiros
            const vplEV = calcularVPL(fluxoEV, tma);
            const vplICE = calcularVPL(fluxoICE, tma);
            const vplDif = vplICE - vplEV; // VPL Diferencial (ICE - EV), positivo √© bom para EV
            
            const fluxoDif = fluxoICE.map((val, i) => val - fluxoEV[i]); // Fluxo incremental (ICE - EV)
            const tir = calcularTIR(fluxoDif) * 100;

            let payback = '-';
            let saldoAcumulado = fluxoDif[0]; // Investimento inicial diferencial
            if (saldoAcumulado < 0) { // S√≥ calcula payback se EV √© mais caro inicialmente
                 for (let ano = 1; ano <= periodo; ano++) {
                    saldoAcumulado += fluxoDif[ano];
                    if (saldoAcumulado >= 0) {
                        // Interpola√ß√£o opcional para payback fracionado (simplificado aqui)
                        payback = ano; 
                        break;
                    }
                }
            } else {
                payback = 0; // EV j√° √© mais barato ou igual no in√≠cio
            }

            // --- Atualiza Interface ---
            document.getElementById('vpl_result').textContent = formatMoney(vplDif);
            document.getElementById('tir_result').textContent = isNaN(tir) ? '-' : tir.toFixed(1);
            document.getElementById('payback_result').textContent = payback;
            document.getElementById('custo_km_ev').textContent = formatMoney(custoKmEV);
            document.getElementById('custo_km_ice').textContent = formatMoney(custoKmICE);
            document.getElementById('economia_total').textContent = formatMoney(vplDif); // VPL j√° representa a economia total em valor presente

            atualizarGraficos(periodo, custoOperacionalEVAnual, custoOperacionalICEAnual, currentEV, currentICE, custoEnergiaEVAnual, custoCombustivelAnual);

            let conclusao = '';
            if (vplDif > 0) {
                conclusao = `‚úÖ An√°lise VPL: O ve√≠culo el√©trico (${currentEV.nome}) √© mais vantajoso, gerando uma economia de ${formatMoney(vplDif)} em valor presente ao longo de ${periodo} anos, comparado ao ${currentICE.nome} neste cen√°rio (${currentProfile}, ${currentScenario}).`;
            } else if (vplDif < 0) {
                 conclusao = `‚ö†Ô∏è An√°lise VPL: O ve√≠culo a combust√£o (${currentICE.nome}) √© mais vantajoso, apresentando um custo ${formatMoney(Math.abs(vplDif))} menor em valor presente ao longo de ${periodo} anos, comparado ao ${currentEV.nome} neste cen√°rio (${currentProfile}, ${currentScenario}).`;
            } else {
                 conclusao = `‚öñÔ∏è An√°lise VPL: Os ve√≠culos apresentam viabilidade econ√¥mica equivalente (${formatMoney(0)}) neste cen√°rio (${currentProfile}, ${currentScenario}) ao longo de ${periodo} anos.`;
            }
             document.getElementById('conclusao_texto').textContent = conclusao;

            const detalhamento = `
                <table class="data-table">
                    <tr><th>Item</th><th>EV (${currentEV.nome})</th><th>ICE (${currentICE.nome})</th><th>Diferen√ßa (ICE-EV)</th></tr>
                    <tr><td>Investimento Inicial</td><td>${formatMoney(currentEV.preco)}</td><td>${formatMoney(currentICE.preco)}</td><td>${formatMoney(currentICE.preco - currentEV.preco)}</td></tr>
                    <tr><td>Custo Anual: Energia/Comb.</td><td>${formatMoney(custoEnergiaEVAnual)}</td><td>${formatMoney(custoCombustivelAnual)}</td><td>${formatMoney(custoCombustivelAnual - custoEnergiaEVAnual)}</td></tr>
                    <tr><td>Custo Anual: Manuten√ß√£o</td><td>${formatMoney(currentEV.manutencao)}</td><td>${formatMoney(currentICE.manutencao)}</td><td>${formatMoney(currentICE.manutencao - currentEV.manutencao)}</td></tr>
                    <tr><td>Custo Anual: Seguro</td><td>${formatMoney(currentEV.seguro)}</td><td>${formatMoney(currentICE.seguro)}</td><td>${formatMoney(currentICE.seguro - currentEV.seguro)}</td></tr>
                    <tr><td>Custo Anual: IPVA</td><td>${formatMoney(currentEV.ipva)}</td><td>${formatMoney(currentICE.ipva)}</td><td>${formatMoney(currentICE.ipva - currentEV.ipva)}</td></tr>
                    <tr><th>Custo Operacional Anual Total</th><th>${formatMoney(custoOperacionalEVAnual)}</th><th>${formatMoney(custoOperacionalICEAnual)}</th><th>${formatMoney(custoOperacionalICEAnual - custoOperacionalEVAnual)}</th></tr>
                    <tr><th>Custo por KM</th><th>${formatMoney(custoKmEV)}</th><th>${formatMoney(custoKmICE)}</th><th>${formatMoney(custoKmICE - custoKmEV)}</th></tr>
                    <tr><td>Valor Residual (Ano ${periodo})</td><td>${formatMoney(currentEV.preco * (currentEV.residual / 100))}</td><td>${formatMoney(currentICE.preco * (currentICE.residual / 100))}</td><td>${formatMoney(currentICE.preco * (currentICE.residual / 100) - currentEV.preco * (currentEV.residual / 100))}</td></tr>
                </table>
            `;
            document.getElementById('detalhamento').innerHTML = detalhamento;
        }
        
        // --- Fun√ß√µes Auxiliares (Mantidas) ---
        function calcularVPL(fluxo, taxa) {
            if (taxa <= -1) return NaN; // Taxa inv√°lida
            return fluxo.reduce((acc, val, i) => acc + val / Math.pow(1 + taxa, i), 0);
        }

        function calcularTIR(fluxo, tentativas = 100, palpiteInicial = 0.1, tolerancia = 0.0001) {
            let taxa = palpiteInicial;
            for (let i = 0; i < tentativas; i++) {
                const vpla = calcularVPL(fluxo, taxa);
                if (Math.abs(vpla) < tolerancia) return taxa; // Encontrou a taxa

                // Derivada do VPL (usando diferen√ßa finita)
                 const vplb = calcularVPL(fluxo, taxa + 0.001);
                 const derivada = (vplb - vpla) / 0.001;

                if (Math.abs(derivada) < 1e-9) break; // Evita divis√£o por zero ou derivada muito pequena

                taxa = taxa - vpla / derivada; // M√©todo de Newton-Raphson

                if (!isFinite(taxa)) break; // Verifica se a taxa se tornou inv√°lida
            }
            return NaN; // N√£o convergiu
        }
        
        function formatMoney(value) {
             if (isNaN(value)) return '-';
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        }
        
        function atualizarGraficos(periodo, custoEVAnual, custoICEAnual, evData, iceData, energiaEVAnual, combustivelICEAnual) {
            const anos = Array.from({length: periodo + 1}, (_, i) => `Ano ${i}`);
            
            // --- Custo Acumulado ---
            const acumEV = [evData.preco];
            const acumICE = [iceData.preco];
            for (let i = 1; i <= periodo; i++) {
                acumEV.push(acumEV[i-1] + custoEVAnual);
                acumICE.push(acumICE[i-1] + custoICEAnual);
            }
            // Adiciona valor residual negativo (como uma "receita") no √∫ltimo ano para visualiza√ß√£o do custo l√≠quido
            acumEV[periodo] -= evData.preco * (evData.residual / 100);
            acumICE[periodo] -= iceData.preco * (iceData.residual / 100);

            if (charts.acumulado) charts.acumulado.destroy();
            charts.acumulado = new Chart(document.getElementById('chartCustoAcumulado'), {
                type: 'line', data: { labels: anos, datasets: [
                    { label: `EV (${evData.nome})`, data: acumEV, borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', tension: 0.1 },
                    { label: `ICE (${iceData.nome})`, data: acumICE, borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.1)', tension: 0.1 }
                ]}, options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'Custo Total Acumulado (L√≠quido do Residual)'}, legend: { display: true, position: 'top' }}}
            });

            // --- Composi√ß√£o Custo Anual ---
             if (charts.composicao) charts.composicao.destroy();
            charts.composicao = new Chart(document.getElementById('chartComposicao'), {
                 type: 'bar', data: { labels: ['EV', 'ICE'], datasets: [
                    { label: 'Energia/Combust√≠vel', data: [energiaEVAnual, combustivelICEAnual], backgroundColor: '#667eea' },
                    { label: 'Manuten√ß√£o', data: [evData.manutencao, iceData.manutencao], backgroundColor: '#f59e0b' },
                    { label: 'Seguro', data: [evData.seguro, iceData.seguro], backgroundColor: '#8b5cf6' },
                    { label: 'IPVA', data: [evData.ipva, iceData.ipva], backgroundColor: '#ec4899' }
                 ]}, options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true, title: { display: true, text: 'R$ / Ano'} } }, plugins: { title: { display: true, text: 'Composi√ß√£o do Custo Operacional Anual'}, legend: { display: true, position: 'top' }}}
            });

            // --- Fluxo de Caixa Diferencial Anual ---
            const fluxoAnualDif = anos.map((_, i) => i === 0 ? iceData.preco - evData.preco : custoICEAnual - custoEVAnual);
             // Inclui o valor residual diferencial no √∫ltimo ano
            fluxoAnualDif[periodo] += (iceData.preco * (iceData.residual / 100)) - (evData.preco * (evData.residual / 100));

            if (charts.fluxo) charts.fluxo.destroy();
            charts.fluxo = new Chart(document.getElementById('chartFluxoCaixa'), {
                type: 'bar', data: { labels: anos, datasets: [{
                    label: 'Economia Anual (ICE - EV)', data: fluxoAnualDif,
                    backgroundColor: fluxoAnualDif.map(v => v >= 0 ? '#10b981' : '#ef4444') // Verde se ICE mais caro, Vermelho se EV mais caro
                }]}, options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'Fluxo de Caixa Incremental Anual (ICE - EV)'}, legend: { display: false }}, scales: { y: { title: { display: true, text: 'R$ / Ano'}}}}
            });
            
             // --- VPL por Perfil (Simula√ß√£o) ---
            const perfisSimulados = Object.keys(db.profiles); // Pega os nomes dos perfis carregados
            const vplPorPerfil = perfisSimulados.map(idPerfil => {
                const perfilSim = db.profiles[idPerfil];
                if (!perfilSim) return 0;

                 // Recalcula custos anuais para este perfil
                 const km = perfilSim.km;
                 const kmUrbSim = km * (perfilSim.urbano / 100);
                 const kmRodSim = km * (1 - perfilSim.urbano / 100);
                 
                 const evConsumoSim = (kmUrbSim * evData.consumoUrb / 100) + (kmRodSim * evData.consumoRod / 100);
                 const evEnergiaSim = evConsumoSim * (perfilSim.recargaRes / 100) * tarifaRes + evConsumoSim * (1 - perfilSim.recargaRes / 100) * tarifaPub;
                 const evTotalSim = evEnergiaSim + evData.manutencao + evData.seguro + evData.ipva;
                 
                 const iceConsumoSim = (kmUrbSim / iceData.consumoUrb) + (kmRodSim / iceData.consumoRod);
                 const iceCombSim = iceConsumoSim * precoGasolina;
                 const iceTotalSim = iceCombSim + iceData.manutencao + iceData.seguro + iceData.ipva;
                 
                 // Monta fluxo diferencial para este perfil
                 const fluxoSim = [- (evData.preco - iceData.preco)]; // Ano 0: Investimento ICE - EV
                 for(let y=1; y<=periodo; y++) fluxoSim.push(iceTotalSim - evTotalSim); // Anos 1 a N: Custo ICE - Custo EV
                 fluxoSim[periodo] += (iceData.preco * (iceData.residual / 100)) - (evData.preco * (evData.residual / 100)); // Residual no final
                 
                 return calcularVPL(fluxoSim, tma / 100); // Calcula o VPL diferencial
            });

            if (charts.perfis) charts.perfis.destroy();
            charts.perfis = new Chart(document.getElementById('chartPerfis'), {
                type: 'bar', data: { labels: perfisSimulados.map(p => p.charAt(0).toUpperCase() + p.slice(1)), // Capitaliza nomes
                    datasets: [{
                        label: 'VPL Diferencial (ICE - EV)', data: vplPorPerfil,
                        backgroundColor: ['#667eea', '#764ba2', '#10b981', '#f59e0b', '#3b82f6', '#ef4444'][i % 6] // Cores variadas
                    }]
                 }, options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: `Vantagem Econ√¥mica do EV por Perfil (VPL em ${periodo} anos)`}, legend: { display: false }}, scales: { y: { title: { display: true, text: 'R$'}}}}
            });
        }
        
        // --- Inicializa√ß√£o ---
        window.addEventListener('load', initializeDashboard_freshStart);

    </script>
</body>
</html>
