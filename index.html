<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard EV vs ICE</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        /* Estilos (Intocados) */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 8px; color: #333; overflow: hidden; height: 100vh; }
        .container { max-width: 100%; height: calc(100vh - 16px); display: flex; flex-direction: column; gap: 6px; }
        .header { background: white; padding: 8px 20px; border-radius: 8px; box-shadow: 0 3px 15px rgba(0,0,0,0.2); display: flex; justify-content: space-between; align-items: center; }
        .header h1 { color: #667eea; font-size: 1.3em; }
        .status { font-size: 0.75em; color: #666; }
        .status.connected { color: #10b981; font-weight: bold; }
        .status.error { color: #ef4444; font-weight: bold; }
        .inputs-wrapper { background: white; padding: 10px; border-radius: 8px; box-shadow: 0 3px 15px rgba(0,0,0,0.2); }
        .inputs-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; }
        .input-card { background: #f8f9fa; border: 2px solid #e0e0e0; border-radius: 8px; padding: 10px; display: flex; flex-direction: column; }
        .input-card h3 { color: #667eea; font-size: 0.9em; margin-bottom: 8px; padding-bottom: 5px; border-bottom: 2px solid #667eea; }
        .form-group { margin-bottom: 6px; }
        .form-group label { display: block; font-size: 0.7em; font-weight: 600; color: #555; margin-bottom: 3px; }
        .form-group select, .form-group input { width: 100%; padding: 5px 7px; border: 2px solid #ddd; border-radius: 5px; font-size: 0.75em; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #667eea; }
        .vehicle-info { background: white; padding: 5px; border-radius: 4px; font-size: 0.65em; margin-top: 3px; color: #666; line-height: 1.3; min-height: 32px; }
        .profile-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-bottom: 6px; }
        .profile-btn { padding: 6px; border: 2px solid #ddd; background: white; border-radius: 6px; cursor: pointer; text-align: center; font-size: 0.65em; transition: all 0.2s; }
        .profile-btn:hover { border-color: #667eea; transform: scale(1.02); }
        .profile-btn.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-color: #667eea; font-weight: bold; }
        .profile-btn div { font-weight: bold; margin-bottom: 1px; }
        .scenario-grid { display: flex; gap: 5px; margin-bottom: 6px; }
        .scenario-btn { flex: 1; padding: 6px; border: 2px solid #ddd; background: white; border-radius: 5px; cursor: pointer; font-size: 0.7em; font-weight: 600; transition: all 0.2s; }
        .scenario-btn:hover { border-color: #667eea; }
        .scenario-btn.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
        .btn-calculate { width: 100%; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 10px; border: none; border-radius: 6px; font-weight: bold; font-size: 0.85em; cursor: pointer; margin-top: auto; }
        .btn-calculate:hover { opacity: 0.9; }
        .results-wrapper { background: white; padding: 10px; border-radius: 8px; box-shadow: 0 3px 15px rgba(0,0,0,0.2); flex: 1; min-height: 0; display: flex; flex-direction: column; gap: 8px; overflow: hidden; }
        .metrics-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; }
        .metric-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 8px; border-radius: 8px; text-align: center; }
        .metric-card h4 { font-size: 0.65em; opacity: 0.9; margin-bottom: 4px; }
        .metric-card .value { font-size: 1.2em; font-weight: bold; margin-bottom: 1px; }
        .metric-card .label { font-size: 0.6em; opacity: 0.8; }
        .content-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 8px; flex: 1; min-height: 0; }
        .charts-grid { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 8px; min-height: 0; }
        .chart-card { background: #f8f9fa; border: 2px solid #e0e0e0; border-radius: 8px; padding: 8px; display: flex; flex-direction: column; min-height: 0; }
        .chart-card h4 { color: #667eea; font-size: 0.8em; margin-bottom: 5px; }
        .chart-container { position: relative; flex: 1; min-height: 0; }
        .right-panel { display: flex; flex-direction: column; gap: 8px; min-height: 0; }
        .conclusion-card { background: #f8f9fa; border: 2px solid #e0e0e0; border-left: 4px solid #667eea; border-radius: 8px; padding: 10px; }
        .conclusion-card h3 { color: #667eea; font-size: 0.85em; margin-bottom: 6px; }
        .conclusion-card p { font-size: 0.7em; line-height: 1.5; color: #555; }
        .table-card { background: #f8f9fa; border: 2px solid #e0e0e0; border-radius: 8px; padding: 8px; flex: 1; overflow-y: auto; min-height: 0; }
        .table-card h4 { color: #667eea; font-size: 0.8em; margin-bottom: 6px; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 0.7em; }
        .data-table th { background: #667eea; color: white; padding: 5px; text-align: left; font-size: 0.9em; }
        .data-table td { padding: 4px 5px; border-bottom: 1px solid #ddd; }
        .data-table tr:nth-child(even) { background: white; }
    </style>
</head>
<body>
    <div class="container"> <div class="header"> <h1>‚ö° An√°lise Econ√¥mica: EV vs ICE</h1> <div class="status" id="connectionStatus">üîÑ Carregando...</div> </div> <div class="inputs-wrapper"> <div class="inputs-grid"> <div class="input-card"> <h3>‚ö° Ve√≠culo El√©trico</h3> <div class="form-group"> <label>Modelo:</label> <select id="ev_select" onchange="loadEV()"> <option value="">Carregando...</option> </select> <div class="vehicle-info" id="ev_info">Selecione um ve√≠culo</div> </div> <div class="form-group"> <label>üí∞ Pre√ßo (R$):</label> <input type="number" id="ev_preco" value="0" step="1000"> </div> </div> <div class="input-card"> <h3>üöó Ve√≠culo Combust√£o</h3> <div class="form-group"> <label>Modelo:</label> <select id="ice_select" onchange="loadICE()"> <option value="">Carregando...</option> </select> <div class="vehicle-info" id="ice_info">Selecione um ve√≠culo</div> </div> <div class="form-group"> <label>üí∞ Pre√ßo (R$):</label> <input type="number" id="ice_preco" value="0" step="1000"> </div> </div> <div class="input-card"> <h3>üë§ Perfil & üí∞ Custos</h3> <div class="profile-grid"> <div class="profile-btn active" onclick="selectProfile(event, 'leve')"> <div>üè† Leve</div> <small>6k km/ano</small> </div> <div class="profile-btn" onclick="selectProfile(event, 'pesado')"> <div>üöô Pesado</div> <small>15k km/ano</small> </div> <div class="profile-btn" onclick="selectProfile(event, 'app')"> <div>üì± App</div> <small>60k km/ano</small> </div> <div class="profile-btn" onclick="selectProfile(event, 'viajante')"> <div>‚úàÔ∏è Viajante</div> <small>28k km/ano</small> </div> </div> <div class="input-row"> <div class="form-group"> <label>Tarifa Res. (R$/kWh):</label> <input type="number" id="tarifa_res" value="0.65" step="0.01"> </div> <div class="form-group"> <label>Tarifa P√∫b. (R$/kWh):</label> <input type="number" id="tarifa_pub" value="1.80" step="0.10"> </div> </div> <div class="form-group"> <label>Gasolina (R$/L):</label> <input type="number" id="preco_gasolina" value="5.80" step="0.10"> </div> </div> <div class="input-card"> <h3>üéØ Cen√°rio</h3> <div class="scenario-grid"> <button class="scenario-btn" onclick="selectScenario(event, 'otimista')">üìà Otim</button> <button class="scenario-btn active" onclick="selectScenario(event, 'base')">üìä Base</button> <button class="scenario-btn" onclick="selectScenario(event, 'pessimista')">üìâ Pess</button> </div> <div class="input-row"> <div class="form-group"> <label>Per√≠odo (anos):</label> <input type="number" id="periodo" value="5" step="1" min="1" max="10"> </div> <div class="form-group"> <label>TMA (%):</label> <input type="number" id="tma" value="10" step="0.5"> </div> </div> <button class="btn-calculate" onclick="calcular()">üöÄ CALCULAR</button> </div> </div> </div> <div class="results-wrapper"> <div class="metrics-grid"> <div class="metric-card"> <h4>VPL DIFERENCIAL</h4> <div class="value" id="vpl_result">-</div> <div class="label">ICE - EV</div> </div> <div class="metric-card"> <h4>TIR</h4> <div class="value" id="tir_result">-</div> <div class="label">%</div> </div> <div class="metric-card"> <h4>PAYBACK</h4> <div class="value" id="payback_result">-</div> <div class="label">anos</div> </div> <div class="metric-card"> <h4>R$/KM EV</h4> <div class="value" id="custo_km_ev">-</div> <div class="label">custo</div> </div> <div class="metric-card"> <h4>R$/KM ICE</h4> <div class="value" id="custo_km_ice">-</div> <div class="label">custo</div> </div> <div class="metric-card"> <h4>ECONOMIA</h4> <div class="value" id="economia_total">-</div> <div class="label">total</div> </div> </div> <div class="content-grid"> <div class="charts-grid"> <div class="chart-card"> <h4>üìä Custo Acumulado</h4> <div class="chart-container"> <canvas id="chartCustoAcumulado"></canvas> </div> </div> <div class="chart-card"> <h4>üí∞ Composi√ß√£o</h4> <div class="chart-container"> <canvas id="chartComposicao"></canvas> </div> </div> <div class="chart-card"> <h4>üìà Fluxo de Caixa</h4> <div class="chart-container"> <canvas id="chartFluxoCaixa"></canvas> </div> </div> <div class="chart-card"> <h4>üéØ Por Perfil</h4> <div class="chart-container"> <canvas id="chartPerfis"></canvas> </div> </div> </div> <div class="right-panel"> <div class="conclusion-card"> <h3>üí° Conclus√£o</h3> <p id="conclusao_texto">Calcule para ver a conclus√£o</p> </div> <div class="table-card"> <h4>üìã Detalhamento</h4> <div id="detalhamento">Calcule para ver os detalhes</div> </div> </div> </div> </div> </div>

    <script>
        // --- Configura√ß√£o ---
        const GOOGLE_SHEETS_CONFIG = {
            SHEET_ID: '1WbsZp2pRYLh6AzEz12xmKdAw2doKRA_9A_DipgbGG2A',
            ABAS: {
                VEICULOS_EV: 'VEICULOS_EV',
                VEICULOS_ICE: 'VEICULOS_ICE',
                PERFIS: 'PERFIS',
                CENARIOS: 'CENARIOS'
            }
        };

        // --- Vari√°veis Globais ---
        let db = { ev: {}, ice: {}, profiles: {}, scenarios: {} };
        let currentProfile = 'leve';
        let currentScenario = 'base';
        let currentEV = null;
        let currentICE = null;
        let charts = {};

        // --- Fun√ß√µes Auxiliares ---
        const getSheetURL = (aba) => {
            const timestamp = new Date().getTime();
            return `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEETS_CONFIG.SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(aba)}&t=${timestamp}`;
        };

        function formatMoney(value) {
             if (isNaN(value) || value === null) return '-';
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        }

         function calculateNPV(cashflow, rate) {
            if (rate <= -1) return NaN;
            return cashflow.reduce((acc, val, i) => acc + val / Math.pow(1 + rate, i), 0);
        }

        function calculateIRR(cashflow, attempts = 100, guess = 0.1, tolerance = 0.0001) {
            let rate = guess;
            for (let i = 0; i < attempts; i++) {
                const npv = calculateNPV(cashflow, rate);
                if (Math.abs(npv) < tolerance) return rate;

                const npvPlus = calculateNPV(cashflow, rate + 0.001);
                const derivative = (npvPlus - npv) / 0.001;

                if (Math.abs(derivative) < 1e-9) break;
                rate = rate - npv / derivative;
                if (!isFinite(rate)) break;
            }
            return NaN;
        }

        // --- Fun√ß√£o Principal de Busca e Processamento (com mais logs) ---
        async function loadAndProcessSheetData_v3(aba, processFunction) {
            console.log(`[v3 Load] Iniciando para: ${aba}`);
            try {
                const url = getSheetURL(aba);
                const response = await fetch(url);

                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const text = await response.text();
                const jsonMatch = text.match(/google\.visualization\.Query\.setResponse\((.*)\);?$/s);

                if (!jsonMatch) throw new Error('Formato inv√°lido (n√£o JSONP)');
                const json = JSON.parse(jsonMatch[1]);

                if (json.status === 'error') throw new Error(`Sheets Error: ${json.errors[0].detailed_message}`);
                if (!json.table?.rows?.length || !json.table.rows[0].c) throw new Error('Tabela vazia ou sem cabe√ßalho');

                // EXTRAIR CABE√áALHOS
                const headers = json.table.rows[0].c.map((cell, i) => cell ? cell.v.trim() : `Col${i}`); // Adicionado .trim()
                console.log(`[v3 Load] Cabe√ßalhos encontrados para ${aba}:`, JSON.stringify(headers)); // Log como string para ver caracteres ocultos

                const dataRows = [];
                // PROCESSAR LINHAS DE DADOS
                for (let i = 1; i < json.table.rows.length; i++) {
                    const rowObject = json.table.rows[i];
                    if (!rowObject?.c) {
                         console.log(`[v3 Load] Pulando linha ${i} (vazia) em ${aba}`);
                         continue;
                    }

                    const rowData = {};
                    let hasContent = false; // Flag para verificar se a linha tem algum dado
                    headers.forEach((header, index) => {
                        const cellValue = rowObject.c[index] ? rowObject.c[index].v : null;
                        rowData[header] = cellValue;
                        if (cellValue !== null && cellValue !== '') hasContent = true;
                    });

                     // LOG DETALHADO DA LINHA (APENAS PRIMEIRAS 2)
                    if (i < 3) {
                         console.log(`[v3 Load] Dados brutos linha ${i} (${aba}):`, JSON.stringify(rowData));
                    }

                    // CRIT√âRIO PARA ADICIONAR LINHA: Deve ter algum conte√∫do E um dos identificadores
                    const idValue = rowData['ID'] ?? rowData['Id'] ?? rowData['id'] ?? null; // Tenta varia√ß√µes de 'ID'
                    const perfilValue = rowData['Perfil'] ?? null;
                    const cenarioValue = rowData['Cenario'] ?? null;

                    if (hasContent && (idValue || perfilValue || cenarioValue)) {
                        // LOG ANTES DE ADICIONAR
                        console.log(`[v3 Load] Adicionando linha ${i} de ${aba}. ID=${idValue}, Perfil=${perfilValue}, Cenario=${cenarioValue}`);
                        dataRows.push(rowData);
                    } else if (hasContent) {
                         console.warn(`[v3 Load] Linha ${i} de ${aba} tem conte√∫do mas foi pulada (sem ID/Perfil/Cenario):`, JSON.stringify(rowData));
                    }
                }
                
                if (dataRows.length === 0) {
                     console.warn(`[v3 Load] Nenhuma linha de dados V√ÅLIDA encontrada para ${aba} ap√≥s o cabe√ßalho.`);
                } else {
                    console.log(`[v3 Load] ${dataRows.length} linhas de dados V√ÅLIDAS encontradas para ${aba}`);
                }

                processFunction(dataRows); // Chama a fun√ß√£o de processamento espec√≠fica
                console.log(`[v3 Load] Processamento conclu√≠do para: ${aba}`);
                return true;

            } catch (error) {
                console.error(`[v3 Load] ERRO FATAL ao carregar ${aba}:`, error.message);
                throw error;
            }
        }

        // --- Fun√ß√µes de Processamento Espec√≠ficas (Ajustadas para nova 'db') ---
         function processEvData_v3(dataRows) {
            db.ev = {};
            dataRows.forEach(row => {
                 const id = row.ID; // Assume que o header √© exatamente 'ID'
                 if (!id) return;
                 db.ev[id] = {
                    id: id, nome: row.Modelo, preco: parseFloat(row.Preco) || 0,
                    consumoUrb: parseFloat(row.Cons_Urb) || 0, consumoRod: parseFloat(row.Cons_Rod) || 0,
                    residual: parseFloat(row.Residual) || 0, manutencao: parseFloat(row.Manutencao) || 0,
                    seguro: parseFloat(row.Seguro) || 0, ipva: parseFloat(row.IPVA) || 0
                };
            });
            console.log(`[v3 Process] EVs carregados: ${Object.keys(db.ev).length}`);
        }
         function processIceData_v3(dataRows) {
             db.ice = {};
             dataRows.forEach(row => {
                 const id = row.ID;
                 if (!id) return;
                 db.ice[id] = {
                    id: id, nome: row.Modelo, preco: parseFloat(row.Preco) || 0,
                    consumoUrb: parseFloat(row.Cons_Urb) || 0, consumoRod: parseFloat(row.Cons_Rod) || 0,
                    residual: parseFloat(row.Residual) || 0, manutencao: parseFloat(row.Manutencao) || 0,
                    seguro: parseFloat(row.Seguro) || 0, ipva: parseFloat(row.IPVA) || 0
                 };
             });
             console.log(`[v3 Process] ICEs carregados: ${Object.keys(db.ice).length}`);
        }
        function processProfileData_v3(dataRows) {
            db.profiles = {};
            dataRows.forEach(row => {
                const profileName = row.Perfil ? row.Perfil.toLowerCase().trim() : null; // Adicionado trim()
                if (!profileName) return;
                db.profiles[profileName] = {
                    km: parseFloat(row.KM_Ano) || 0,
                    urbano: parseFloat(row.Prop_Urbano) * 100 || 0,
                    recargaRes: parseFloat(row.Recarga_Res) * 100 || 0
                };
            });
            console.log(`[v3 Process] Perfis carregados: ${Object.keys(db.profiles).length}`);
        }
        function processScenarioData_v3(dataRows) {
            db.scenarios = {};
             dataRows.forEach(row => {
                 const scenarioName = row.Cenario ? row.Cenario.toLowerCase().trim() : null; // Adicionado trim()
                 if (!scenarioName) return;
                 db.scenarios[scenarioName] = {
                    gasolina: parseFloat(row.Gasolina) || 0,
                    tarifaRes: parseFloat(row.Tarifa_Res) || 0,
                    tarifaPub: parseFloat(row.Tarifa_Pub) || 0
                 };
             });
            console.log(`[v3 Process] Cen√°rios carregados: ${Object.keys(db.scenarios).length}`);
        }

        // --- Fun√ß√£o de Inicializa√ß√£o Principal (Nova v3) ---
        async function initializeDashboard_v3() {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.textContent = 'üîÑ Carregando v3...';
            console.log('=== INICIANDO DASHBOARD (v3) ===');
            try {
                await Promise.all([
                    loadAndProcessSheetData_v3(GOOGLE_SHEETS_CONFIG.ABAS.VEICULOS_EV, processEvData_v3),
                    loadAndProcessSheetData_v3(GOOGLE_SHEETS_CONFIG.ABAS.VEICULOS_ICE, processIceData_v3),
                    loadAndProcessSheetData_v3(GOOGLE_SHEETS_CONFIG.ABAS.PERFIS, processProfileData_v3),
                    loadAndProcessSheetData_v3(GOOGLE_SHEETS_CONFIG.ABAS.CENARIOS, processScenarioData_v3)
                ]);

                if (!Object.keys(db.ev).length) throw new Error('EVs n√£o carregados');
                if (!Object.keys(db.ice).length) throw new Error('ICEs n√£o carregados');
                if (!Object.keys(db.profiles).length) throw new Error('Perfis n√£o carregados');
                if (!Object.keys(db.scenarios).length) throw new Error('Cen√°rios n√£o carregados');

                console.log('üöÄ Sucesso v3! Todos os dados ok.');
                populateDropdowns_v3(); // Chama a fun√ß√£o com novo nome
                statusEl.textContent = '‚úÖ Conectado v3';
                statusEl.classList.add('connected');
                statusEl.classList.remove('error');
            } catch (error) {
                console.error('‚ùå ERRO FATAL v3:', error);
                statusEl.textContent = `‚ö†Ô∏è Erro v3: ${error.message}`;
                statusEl.classList.add('error');
            }
        }

        // --- Fun√ß√µes da Interface (Renomeadas e usando 'db') ---
        function populateDropdowns_v3() { /* ... c√≥digo igual a populateDropdowns ... */
             console.log('[v3 Populate] Iniciando...');
            const evSelect = document.getElementById('ev_select');
            const iceSelect = document.getElementById('ice_select');
            evSelect.innerHTML = '<option value="">Selecione EV</option>';
            Object.keys(db.ev).sort((a,b) => db.ev[a].nome.localeCompare(db.ev[b].nome)).forEach(id => { // Ordena por nome
                evSelect.innerHTML += `<option value="${id}">${db.ev[id].nome}</option>`;
            });
            iceSelect.innerHTML = '<option value="">Selecione ICE</option>';
             Object.keys(db.ice).sort((a,b) => db.ice[a].nome.localeCompare(db.ice[b].nome)).forEach(id => { // Ordena por nome
                iceSelect.innerHTML += `<option value="${id}">${db.ice[id].nome}</option>`;
            });
            console.log('[v3 Populate] Conclu√≠do.');
        }
        function loadEV() { /* ... c√≥digo igual a loadEV ... */
             const id = document.getElementById('ev_select').value;
             if (!id || !db.ev[id]) { currentEV = null; document.getElementById('ev_info').textContent = 'Selecione'; document.getElementById('ev_preco').value = 0; return; }
             currentEV = db.ev[id]; document.getElementById('ev_preco').value = currentEV.preco;
             document.getElementById('ev_info').innerHTML = `üí° ${currentEV.consumoUrb} kWh/100km (urb) | ${currentEV.consumoRod} kWh/100km (rod)<br>üí∞ Seg: ${formatMoney(currentEV.seguro)} | Man: ${formatMoney(currentEV.manutencao)}/ano`;
        }
        function loadICE() { /* ... c√≥digo igual a loadICE ... */
             const id = document.getElementById('ice_select').value;
             if (!id || !db.ice[id]) { currentICE = null; document.getElementById('ice_info').textContent = 'Selecione'; document.getElementById('ice_preco').value = 0; return; }
             currentICE = db.ice[id]; document.getElementById('ice_preco').value = currentICE.preco;
             document.getElementById('ice_info').innerHTML = `‚õΩ ${currentICE.consumoUrb} km/L (urb) | ${currentICE.consumoRod} km/L (rod)<br>üí∞ Seg: ${formatMoney(currentICE.seguro)} | Man: ${formatMoney(currentICE.manutencao)}/ano`;
        }
        function selectProfile(event, profile) { /* ... c√≥digo igual a selectProfile ... */
             currentProfile = profile; document.querySelectorAll('.profile-btn').forEach(btn => btn.classList.remove('active')); event.target.closest('.profile-btn').classList.add('active');
        }
        function selectScenario(event, scenario) { /* ... c√≥digo igual a selectScenario ... */
             currentScenario = scenario; document.querySelectorAll('.scenario-btn').forEach(btn => btn.classList.remove('active')); event.target.classList.add('active');
             if (db.scenarios[scenario]) { document.getElementById('preco_gasolina').value = db.scenarios[scenario].gasolina; document.getElementById('tarifa_res').value = db.scenarios[scenario].tarifaRes; document.getElementById('tarifa_pub').value = db.scenarios[scenario].tarifaPub; }
        }
        function calcular() { /* ... c√≥digo igual a calcular ... */
            if (!currentEV || !currentICE) { alert('Selecione ambos os ve√≠culos!'); return; }
            const perfil = db.profiles[currentProfile]; if (!perfil) { alert('Perfil inv√°lido!'); return; }
            const periodo = parseInt(document.getElementById('periodo').value); const tma = parseFloat(document.getElementById('tma').value) / 100;
            const tarifaRes = parseFloat(document.getElementById('tarifa_res').value); const tarifaPub = parseFloat(document.getElementById('tarifa_pub').value); const precoGasolina = parseFloat(document.getElementById('preco_gasolina').value);
            const kmAnual = perfil.km; const kmUrb = kmAnual * (perfil.urbano / 100); const kmRod = kmAnual * (1 - perfil.urbano / 100);
            const consumoTotalEV_kWh = (kmUrb * currentEV.consumoUrb / 100) + (kmRod * currentEV.consumoRod / 100);
            const custoEnergiaEVAnual = consumoTotalEV_kWh * (perfil.recargaRes / 100) * tarifaRes + consumoTotalEV_kWh * (1 - perfil.recargaRes / 100) * tarifaPub;
            const custoOperacionalEVAnual = custoEnergiaEVAnual + currentEV.manutencao + currentEV.seguro + currentEV.ipva; const custoKmEV = kmAnual > 0 ? custoOperacionalEVAnual / kmAnual : 0;
            const consumoTotalICE_L = (kmUrb / currentICE.consumoUrb) + (kmRod / currentICE.consumoRod); const custoCombustivelAnual = consumoTotalICE_L * precoGasolina;
            const custoOperacionalICEAnual = custoCombustivelAnual + currentICE.manutencao + currentICE.seguro + currentICE.ipva; const custoKmICE = kmAnual > 0 ? custoOperacionalICEAnual / kmAnual : 0;
            const fluxoEV = [-currentEV.preco]; const fluxoICE = [-currentICE.preco];
            for (let ano = 1; ano <= periodo; ano++) { fluxoEV.push(-custoOperacionalEVAnual); fluxoICE.push(-custoOperacionalICEAnual); }
            fluxoEV[periodo] += currentEV.preco * (currentEV.residual / 100); fluxoICE[periodo] += currentICE.preco * (currentICE.residual / 100);
            const vplEV = calculateNPV(fluxoEV, tma); const vplICE = calculateNPV(fluxoICE, tma); const vplDif = vplICE - vplEV;
            const fluxoDif = fluxoICE.map((val, i) => val - fluxoEV[i]); const tir = calculateIRR(fluxoDif) * 100;
            let payback = '-'; let saldoAcumulado = fluxoDif[0];
            if (saldoAcumulado < 0) { for (let ano = 1; ano <= periodo; ano++) { saldoAcumulado += fluxoDif[ano]; if (saldoAcumulado >= 0) { payback = ano; break; } } } else { payback = 0; }
            document.getElementById('vpl_result').textContent = formatMoney(vplDif); document.getElementById('tir_result').textContent = isNaN(tir) ? '-' : tir.toFixed(1);
            document.getElementById('payback_result').textContent = payback; document.getElementById('custo_km_ev').textContent = formatMoney(custoKmEV);
            document.getElementById('custo_km_ice').textContent = formatMoney(custoKmICE); document.getElementById('economia_total').textContent = formatMoney(vplDif);
            atualizarGraficos_v3(periodo, custoOperacionalEVAnual, custoOperacionalICEAnual, currentEV, currentICE, custoEnergiaEVAnual, custoCombustivelAnual); // Chama v3
            let conclusao = ''; if (vplDif > 0) conclusao = `‚úÖ An√°lise VPL: O VE (${currentEV.nome}) √© mais vantajoso (+${formatMoney(vplDif)}) em ${periodo} anos vs ${currentICE.nome} (${currentProfile}, ${currentScenario}).`; else if (vplDif < 0) conclusao = `‚ö†Ô∏è An√°lise VPL: O ICE (${currentICE.nome}) √© mais vantajoso (+${formatMoney(Math.abs(vplDif))}) em ${periodo} anos vs ${currentEV.nome} (${currentProfile}, ${currentScenario}).`; else conclusao = `‚öñÔ∏è An√°lise VPL: Viabilidade econ√¥mica equivalente (${formatMoney(0)}) em ${periodo} anos (${currentProfile}, ${currentScenario}).`;
            document.getElementById('conclusao_texto').textContent = conclusao;
            const detalhamento = `<table class="data-table"><tr><th>Item</th><th>EV (${currentEV.nome})</th><th>ICE (${currentICE.nome})</th><th>Dif (ICE-EV)</th></tr><tr><td>Investimento</td><td>${formatMoney(currentEV.preco)}</td><td>${formatMoney(currentICE.preco)}</td><td>${formatMoney(currentICE.preco - currentEV.preco)}</td></tr><tr><td>Custo Anual: Energia/Comb.</td><td>${formatMoney(custoEnergiaEVAnual)}</td><td>${formatMoney(custoCombustivelAnual)}</td><td>${formatMoney(custoCombustivelAnual - custoEnergiaEVAnual)}</td></tr><tr><td>Custo Anual: Manuten√ß√£o</td><td>${formatMoney(currentEV.manutencao)}</td><td>${formatMoney(currentICE.manutencao)}</td><td>${formatMoney(currentICE.manutencao - currentEV.manutencao)}</td></tr><tr><td>Custo Anual: Seguro</td><td>${formatMoney(currentEV.seguro)}</td><td>${formatMoney(currentICE.seguro)}</td><td>${formatMoney(currentICE.seguro - currentEV.seguro)}</td></tr><tr><td>Custo Anual: IPVA</td><td>${formatMoney(currentEV.ipva)}</td><td>${formatMoney(currentICE.ipva)}</td><td>${formatMoney(currentICE.ipva - currentEV.ipva)}</td></tr><tr><th>Custo Op. Anual Total</th><th>${formatMoney(custoOperacionalEVAnual)}</th><th>${formatMoney(custoOperacionalICEAnual)}</th><th>${formatMoney(custoOperacionalICEAnual - custoOperacionalEVAnual)}</th></tr><tr><th>Custo/KM</th><th>${formatMoney(custoKmEV)}</th><th>${formatMoney(custoKmICE)}</th><th>${formatMoney(custoKmICE - custoKmEV)}</th></tr><tr><td>Valor Residual (Ano ${periodo})</td><td>${formatMoney(currentEV.preco * (currentEV.residual / 100))}</td><td>${formatMoney(currentICE.preco * (currentICE.residual / 100))}</td><td>${formatMoney(currentICE.preco * (currentICE.residual / 100) - currentEV.preco * (currentEV.residual / 100))}</td></tr></table>`;
            document.getElementById('detalhamento').innerHTML = detalhamento;
        }
        function atualizarGraficos_v3(periodo, custoEVAnual, custoICEAnual, evData, iceData, energiaEVAnual, combustivelICEAnual) { /* ... c√≥digo igual a atualizarGraficos ... */
             const anos = Array.from({length: periodo + 1}, (_, i) => `Ano ${i}`);
             const acumEV = [evData.preco]; const acumICE = [iceData.preco];
             for (let i = 1; i <= periodo; i++) { acumEV.push(acumEV[i-1] + custoEVAnual); acumICE.push(acumICE[i-1] + custoICEAnual); }
             acumEV[periodo] -= evData.preco * (evData.residual / 100); acumICE[periodo] -= iceData.preco * (iceData.residual / 100);
             if (charts.acumulado) charts.acumulado.destroy();
             charts.acumulado = new Chart(document.getElementById('chartCustoAcumulado'), { type: 'line', data: { labels: anos, datasets: [ { label: `EV (${evData.nome})`, data: acumEV, borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', tension: 0.1 }, { label: `ICE (${iceData.nome})`, data: acumICE, borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.1)', tension: 0.1 } ]}, options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'Custo Total Acumulado (L√≠quido do Residual)'}, legend: { display: true, position: 'top' }}} });
             if (charts.composicao) charts.composicao.destroy();
             charts.composicao = new Chart(document.getElementById('chartComposicao'), { type: 'bar', data: { labels: ['EV', 'ICE'], datasets: [ { label: 'Energia/Combust√≠vel', data: [energiaEVAnual, combustivelICEAnual], backgroundColor: '#667eea' }, { label: 'Manuten√ß√£o', data: [evData.manutencao, iceData.manutencao], backgroundColor: '#f59e0b' }, { label: 'Seguro', data: [evData.seguro, iceData.seguro], backgroundColor: '#8b5cf6' }, { label: 'IPVA', data: [evData.ipva, iceData.ipva], backgroundColor: '#ec4899' } ]}, options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true, title: { display: true, text: 'R$ / Ano'} } }, plugins: { title: { display: true, text: 'Composi√ß√£o do Custo Operacional Anual'}, legend: { display: true, position: 'top' }}} });
             const fluxoAnualDif = anos.map((_, i) => i === 0 ? iceData.preco - evData.preco : custoICEAnual - custoEVAnual);
             fluxoAnualDif[periodo] += (iceData.preco * (iceData.residual / 100)) - (evData.preco * (evData.residual / 100));
             if (charts.fluxo) charts.fluxo.destroy();
             charts.fluxo = new Chart(document.getElementById('chartFluxoCaixa'), { type: 'bar', data: { labels: anos, datasets: [{ label: 'Economia Anual (ICE - EV)', data: fluxoAnualDif, backgroundColor: fluxoAnualDif.map(v => v >= 0 ? '#10b981' : '#ef4444') }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'Fluxo de Caixa Incremental Anual (ICE - EV)'}, legend: { display: false }}, scales: { y: { title: { display: true, text: 'R$ / Ano'}}}} });
             const perfisSimulados = Object.keys(db.profiles); const tmaRate = parseFloat(document.getElementById('tma').value) / 100; const tarifaRes = parseFloat(document.getElementById('tarifa_res').value); const tarifaPub = parseFloat(document.getElementById('tarifa_pub').value); const precoGasolina = parseFloat(document.getElementById('preco_gasolina').value);
             const vplPorPerfil = perfisSimulados.map(idPerfil => { const perfilSim = db.profiles[idPerfil]; if (!perfilSim) return 0; const km = perfilSim.km; const kmUrbSim = km * (perfilSim.urbano / 100); const kmRodSim = km * (1 - perfilSim.urbano / 100); const evConsumoSim = (kmUrbSim * evData.consumoUrb / 100) + (kmRodSim * evData.consumoRod / 100); const evEnergiaSim = evConsumoSim * (perfilSim.recargaRes / 100) * tarifaRes + evConsumoSim * (1 - perfilSim.recargaRes / 100) * tarifaPub; const evTotalSim = evEnergiaSim + evData.manutencao + evData.seguro + evData.ipva; const iceConsumoSim = (kmUrbSim / iceData.consumoUrb) + (kmRodSim / iceData.consumoRod); const iceCombSim = iceConsumoSim * precoGasolina; const iceTotalSim = iceCombSim + iceData.manutencao + iceData.seguro + iceData.ipva; const fluxoSim = [- (evData.preco - iceData.preco)]; for(let y=1; y<=periodo; y++) fluxoSim.push(iceTotalSim - evTotalSim); fluxoSim[periodo] += (iceData.preco * (iceData.residual / 100)) - (evData.preco * (evData.residual / 100)); return calculateNPV(fluxoSim, tmaRate); });
             if (charts.perfis) charts.perfis.destroy();
             charts.perfis = new Chart(document.getElementById('chartPerfis'), { type: 'bar', data: { labels: perfisSimulados.map(p => p.charAt(0).toUpperCase() + p.slice(1)), datasets: [{ label: 'VPL Diferencial (ICE - EV)', data: vplPorPerfil, backgroundColor: perfisSimulados.map((p, i) => ['#667eea', '#764ba2', '#10b981', '#f59e0b', '#3b82f6', '#ef4444'][i % 6]) }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: `Vantagem Econ√¥mica do EV por Perfil (VPL ${periodo}a @ ${tmaRate*100}%)`}, legend: { display: false }}, scales: { y: { title: { display: true, text: 'R$'}}}} });
        }
        
        // --- Inicializa√ß√£o ---
        window.addEventListener('load', initializeDashboard_v3); // Chama a nova fun√ß√£o principal
    </script>
</body>
</html>
