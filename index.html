<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard EV vs ICE</title>

    <style>
        /* =========================================================
           VARI√ÅVEIS E CONFIGURA√á√ÉO GLOBAL
           ========================================================= */
        :root {
            --grad-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --grad-btn: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --borda: rgba(255,255,255,0.25);
        }
        * {margin:0;padding:0;box-sizing:border-box;}
        html, body {height:100%;overflow:hidden;}
        body {
            font-family:"Segoe UI",Tahoma,sans-serif;
            background:var(--grad-bg);color:#fff;
            display:flex;flex-direction:column;
            justify-content:center;align-items:flex-start;
            padding-left:24px;
        }

        /* =========================================================
           CABE√áALHO
           ========================================================= */
        .header {
            width:940px;
            background:rgba(255,255,255,0.2);
            border-radius:10px;
            padding:8px 18px;margin-bottom:10px;
            display:flex;justify-content:space-between;align-items:center;
            box-shadow:0 3px 10px rgba(0,0,0,0.2);
        }
        .header h1{font-size:1.2rem;}

        /* =========================================================
           GRID PRINCIPAL
           ========================================================= */
        .dashboard {
            display:grid;
            grid-template-columns:1fr 1fr;
            grid-template-rows:auto auto;
            gap:8px;
            width:940px;
        }

        /* =========================================================
           CARDS PADR√ÉO
           ========================================================= */
        .card {
            background:rgba(255,255,255,0.15);
            border:1px solid var(--borda);
            border-radius:12px;
            padding:8px;
            backdrop-filter:blur(6px);
            box-shadow:0 3px 8px rgba(0,0,0,0.15);
        }
        .card h3 {
            font-size:0.9rem;font-weight:700;
            border-bottom:1.5px solid rgba(255,255,255,0.3);
            padding-bottom:3px;margin-bottom:6px;
        }

        /* =========================================================
           FORMUL√ÅRIOS GERAIS
           ========================================================= */
        label{font-size:0.75rem;font-weight:600;color:#fff;}
        input,select{
            width:100%;padding:5px 7px;border-radius:8px;
            border:1.5px solid rgba(255,255,255,0.5);
            background:rgba(255,255,255,0.4);color:#111;font-size:0.85rem;
        }

        /* =========================================================
           VE√çCULOS
           ========================================================= */
        .vehicle-img{
            width:100%;height:120px;object-fit:contain;
            border-radius:8px;background:#fff;margin:6px 0;
        }
        .vehicle-info{
            display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));
            gap:6px;min-height:85px;
        }
        .v-card{
            background:rgba(255,255,255,0.5);border-radius:8px;
            text-align:center;padding:6px;color:#111;font-size:0.7rem;
            height:70px;display:flex;flex-direction:column;justify-content:center;
        }
        .v-card img{width:20px;height:20px;margin:0 auto 2px;display:block;}
        .v-card .emoji{display:block;font-size:1.1rem;}
        .v-card .value{font-weight:bold;}

        /* =========================================================
           PERFIL
           ========================================================= */
        .profile-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;}
        .profile-pill{
            background:rgba(255,255,255,0.4);
            border:1.5px solid rgba(255,255,255,0.5);
            border-radius:10px;padding:8px;
            display:flex;align-items:center;gap:10px;
            color:#111;cursor:pointer;transition:0.25s;
        }
        .profile-pill:hover{background:rgba(255,255,255,0.65);}
        .profile-pill.active{background:var(--grad-btn);color:#fff;border:none;}
        .profile-emoji{font-size:1.9rem;line-height:1;}
        .profile-info{display:flex;flex-direction:column;line-height:1.15;}
        .profile-info .name{font-weight:700;font-size:0.85rem;}
        .profile-info .details{font-size:0.72rem;}

        /* =========================================================
           CEN√ÅRIOS
           ========================================================= */
        .scenario-row{display:flex;gap:6px;margin-bottom:6px;}
        .scenario-btn{
            flex:1;border-radius:8px;padding:5px 6px;
            border:1.5px solid rgba(255,255,255,0.5);
            background:rgba(255,255,255,0.4);color:#111;
            font-weight:700;font-size:0.75rem;cursor:pointer;transition:0.25s;
            display:flex;justify-content:center;align-items:center;gap:5px;
        }
        .scenario-btn.active{background:var(--grad-btn);color:#fff;border:none;}
        .inputs-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:4px;}
        .inputs-grid-2{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:4px;}
        .btn-calc{width:100%;background:var(--grad-btn);color:#fff;border:none;
            border-radius:8px;font-weight:700;padding:8px;cursor:pointer;}

        /* =========================================================
           RESULTADOS
           ========================================================= */
        .result-card{
            grid-column:2/3;grid-row:2/span 2;
            background:rgba(255,255,255,0.15);
            border:1px solid var(--borda);border-radius:12px;padding:8px;
            backdrop-filter:blur(6px);box-shadow:0 3px 10px rgba(0,0,0,0.25);
            display:flex;flex-direction:column;justify-content:flex-start;
        }
        .result-card h3{
            font-size:0.9rem;font-weight:700;
            border-bottom:1.5px solid rgba(255,255,255,0.3);
            padding-bottom:3px;margin-bottom:8px;
        }
        .result-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
        .result-col{display:flex;flex-direction:column;gap:8px;}
        .result-box{
            background:linear-gradient(135deg,#6b73ff 0%,#8b5cf6 100%);
            border-radius:12px;text-align:center;padding:12px 10px;
            color:#fff;box-shadow:0 3px 10px rgba(0,0,0,0.25);
            height:80px;display:flex;flex-direction:column;justify-content:center;
        }
        .result-box h4{margin:0;font-size:0.9rem;font-weight:600;}
        .result-box .value{font-weight:bold;font-size:1.05rem;margin-top:5px;}
        .result-payback{grid-column:1/span 2;margin-top:6px;}
    </style>
</head>

<body>
<div class="header">
    <h1>‚ö° An√°lise Econ√¥mica: EV vs ICE</h1>
    <span style="font-size:0.8rem;opacity:0.8;">Vers√£o conectada √† planilha</span>
</div>

<div class="dashboard">
    <!-- ‚ö° VE√çCULO EL√âTRICO -->
    <div class="card" id="cardEV">
        <h3>‚ö° Ve√≠culo El√©trico</h3>
        <label>Modelo:</label>
        <select id="selEV"><option>Selecione um modelo</option></select>
        <label>üí∞ Pre√ßo (R$):</label>
        <!-- EDIT√ÅVEL (removido readonly) -->
        <input id="precoEV">
        <img id="imgEV" class="vehicle-img" src="https://i.imgur.com/MLNARfh.png">
        <div id="infoEV" class="vehicle-info">
            <div class="v-card"><span class="emoji">üìÖ</span>Ano<br><span class="value">‚Äî</span></div>
            <div class="v-card"><span class="emoji">‚ö°</span>Consumo Urbano<br><span class="value">‚Äî</span></div>
            <div class="v-card"><span class="emoji">‚ö°</span>Consumo Rodovi√°rio<br><span class="value">‚Äî</span></div>
            <div class="v-card"><span class="emoji">üõ†Ô∏è</span>Manuten√ß√£o<br><span class="value">‚Äî</span></div>
            <div class="v-card"><span class="emoji">üßæ</span>Seguro<br><span class="value">‚Äî</span></div>
            <div class="v-card"><span class="emoji">üí∞</span>IPVA<br><span class="value">‚Äî</span></div>
            <div class="v-card"><img src="https://i.imgur.com/kQOANzQ.png">Pneus<br><span class="value">‚Äî</span></div>
            <div class="v-card"><span class="emoji">üíµ</span>Residual<br><span class="value">‚Äî</span></div>
        </div>
    </div>

    <!-- üöó VE√çCULO COMBUST√ÉO -->
    <div class="card" id="cardICE">
        <h3>üöó Ve√≠culo Combust√£o</h3>
        <label>Modelo:</label>
        <select id="selICE"><option>Selecione um modelo</option></select>
        <label>üí∞ Pre√ßo (R$):</label>
        <!-- EDIT√ÅVEL (removido readonly) -->
        <input id="precoICE">
        <img id="imgICE" class="vehicle-img" src="https://i.imgur.com/MLNARfh.png">
        <div id="infoICE" class="vehicle-info">
            <div class="v-card"><span class="emoji">üìÖ</span>Ano<br><span class="value">‚Äî</span></div>
            <div class="v-card"><span class="emoji">‚õΩ</span>Consumo Urbano<br><span class="value">‚Äî</span></div>
            <div class="v-card"><span class="emoji">‚õΩ</span>Consumo Rodovi√°rio<br><span class="value">‚Äî</span></div>
            <div class="v-card"><span class="emoji">üõ†Ô∏è</span>Manuten√ß√£o<br><span class="value">‚Äî</span></div>
            <div class="v-card"><span class="emoji">üßæ</span>Seguro<br><span class="value">‚Äî</span></div>
            <div class="v-card"><span class="emoji">üí∞</span>IPVA<br><span class="value">‚Äî</span></div>
            <div class="v-card"><img src="https://i.imgur.com/kQOANzQ.png">Pneus<br><span class="value">‚Äî</span></div>
            <div class="v-card"><span class="emoji">üíµ</span>Residual<br><span class="value">‚Äî</span></div>
        </div>
    </div>

    <!-- üë§ PERFIL -->
    <div class="card" style="grid-column:1/2;">
        <h3>üë§ Perfil</h3>
        <div id="perfisContainer" class="profile-grid">Carregando...</div>
    </div>

    <!-- üéØ CEN√ÅRIO -->
    <div class="card" style="grid-column:1/2;">
        <h3>üéØ Cen√°rio</h3>
        <div id="cenariosContainer" class="scenario-row"></div>
        <div class="inputs-grid">
            <div><label>Tarifa Res. (R$/kWh):</label><input id="tarifaRes"></div>
            <div><label>Tarifa P√∫b. (R$/kWh):</label><input id="tarifaPub"></div>
            <div><label>Gasolina (R$/L):</label><input id="precoGas"></div>
        </div>
        <div class="inputs-grid-2">
            <div><label>Per√≠odo (anos):</label><input id="anos" type="number"></div>
            <div><label>TMA (%):</label><input id="tma"></div>
        </div>
        <button class="btn-calc" id="btnCalcular">üöÄ CALCULAR</button>
    </div>

    <!-- üìä RESULTADOS -->
    <div class="result-card">
        <h3>üìä Resultados</h3>
        <div class="result-grid">
            <div class="result-col">
                <div class="result-box"><h4>‚ö° R$/KM EV</h4><span class="value" id="resEV">‚Äî</span></div>
                <div class="result-box"><h4>üåø Custo Total EV</h4><span class="value" id="custoEV">‚Äî</span></div>
                <div class="result-box"><h4>üìâ VPL Diferen√ßa</h4><span class="value" id="vpl">‚Äî</span></div>
            </div>
            <div class="result-col">
                <div class="result-box"><h4>‚õΩ R$/KM ICE</h4><span class="value" id="resICE">‚Äî</span></div>
                <div class="result-box"><h4>üî• Custo Total ICE</h4><span class="value" id="custoICE">‚Äî</span></div>
                <div class="result-box"><h4>üìà TIR Diferen√ßa</h4><span class="value" id="tir">‚Äî</span></div>
            </div>
            <div class="result-box result-payback">
                <h4>‚è≥ Payback Descontado</h4><span class="value" id="payback">‚Äî</span>
            </div>
        </div>
    </div>
</div>

<script>
    // === LINKS DAS PLANILHAS ===
    const URLS = {
        VEICULOS: "https://api.allorigins.win/raw?url=" + encodeURIComponent("https://docs.google.com/spreadsheets/d/e/2PACX-1vSUihOaIXPK9JWb5tXTp3YB0ALT-YIwVdZEeUtMa_CY8chVqzBayBQpnxQTkqLhvPwLVNgddsmZXGAo/pub?gid=0&single=true&output=csv"),
        PERFIS: "https://api.allorigins.win/raw?url=" + encodeURIComponent("https://docs.google.com/spreadsheets/d/e/2PACX-1vSUihOaIXPK9JWb5tXTp3YB0ALT-YIwVdZEeUtMa_CY8chVqzBayBQpnxQTkqLhvPwLVNgddsmZXGAo/pub?gid=155387580&single=true&output=csv"),
        CENARIOS: "https://api.allorigins.win/raw?url=" + encodeURIComponent("https://docs.google.com/spreadsheets/d/e/2PACX-1vSUihOaIXPK9JWb5tXTp3YB0ALT-YIwVdZEeUtMa_CY8chVqzBayBQpnxQTkqLhvPwLVNgddsmZXGAo/pub?gid=1970963524&single=true&output=csv")
    };

    // === FORMATA√á√ÉO BR ===
    const toNumBR=v=>parseFloat(String(v||"").replace(/\./g,"").replace(",",".").trim())||0;
    const moneyBR=n=>"R$ "+(Number(n)||0).toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2});
    const moneyBR4=n=>"R$ "+(Number(n)||0).toLocaleString("pt-BR",{minimumFractionDigits:4,maximumFractionDigits:4});

    // === LER CSV ===
    async function getCSV(url){
        const res=await fetch(url);
        const text=await res.text();
        const lines=text.trim().split(/\r?\n/).map(l=>l.split(/,(?=(?:[^\"]*\"[^\"]*\")*[^\"]*$)/).map(c=>c.replace(/^\"|\"$/g,'')));
        const headers=lines.shift();
        return lines.map(row=>{
            const o={};
            headers.forEach((h,i)=>o[h.trim()]=(row[i]||'').trim());
            return o;
        });
    }

    let dataVeiculos=[],dataPerfis=[],dataCenarios=[];
    let selecionadoEV=null,selecionadoICE=null,selecionadoPerfil=null,selecionadoCenario=null;

    // === POPULAR VE√çCULOS ===
    function popularVeiculos(){
        const selEV=document.getElementById('selEV');
        const selICE=document.getElementById('selICE');
        selEV.innerHTML='<option>Selecione um modelo</option>';
        selICE.innerHTML='<option>Selecione um modelo</option>';
        dataVeiculos.filter(v=>v.tipo.toUpperCase()==='EV').forEach(v=>{
            const o=document.createElement('option');o.value=v.modelo;o.textContent=v.modelo;selEV.appendChild(o);
        });
        dataVeiculos.filter(v=>v.tipo.toUpperCase()==='ICE').forEach(v=>{
            const o=document.createElement('option');o.value=v.modelo;o.textContent=v.modelo;selICE.appendChild(o);
        });
    }

    // === ATUALIZAR INFORMA√á√ïES DOS VE√çCULOS ===
    function atualizarInfoVeiculo(v,infoId,precoId,imgId,isEV){
        const infoEl=document.getElementById(infoId);
        const precoEl=document.getElementById(precoId);
        const imgEl=document.getElementById(imgId);
        if(!v){
            precoEl.value='';imgEl.src='https://i.imgur.com/MLNARfh.png';
            infoEl.querySelectorAll('.value').forEach(e=>e.textContent='‚Äî');
            return;
        }
        precoEl.value = toNumBR(v.preco_inicial).toLocaleString('pt-BR', {minimumFractionDigits:2, maximumFractionDigits:2});
        imgEl.src=v.imagem||'https://i.imgur.com/MLNARfh.png';
        const setVal=(label,val)=>{const card=[...infoEl.querySelectorAll('.v-card')].find(c=>c.textContent.includes(label));if(card)card.querySelector('.value').textContent=val;};
        setVal('Ano',v.ano||'‚Äî');
        setVal('Consumo Urbano',v.consumo_urb?toNumBR(v.consumo_urb).toLocaleString('pt-BR',{minimumFractionDigits:2})+(isEV?' km/kWh':' km/L'):'‚Äî');
        setVal('Consumo Rodovi√°rio',v.consumo_rod?toNumBR(v.consumo_rod).toLocaleString('pt-BR',{minimumFractionDigits:2})+(isEV?' km/kWh':' km/L'):'‚Äî');
        setVal('Manuten√ß√£o',v.manutencao_anual?moneyBR(toNumBR(v.manutencao_anual)):'‚Äî');
        setVal('Seguro',v.seguro_anual?moneyBR(toNumBR(v.seguro_anual)):'‚Äî');
        setVal('IPVA',v.ipva_anual?moneyBR(toNumBR(v.ipva_anual)):'‚Äî');
        setVal('Pneus',v.pneus_ano?moneyBR(toNumBR(v.pneus_ano)):'‚Äî');
        const resPct=v['residual_%']?(toNumBR(v['residual_%'])*100).toFixed(0)+'%':'‚Äî';
        setVal('Residual',resPct);
    }

    // === POPULAR PERFIS ===
    function popularPerfis(){
        const box=document.getElementById('perfisContainer');
        box.innerHTML='';
        dataPerfis.forEach((p,i)=>{
            const emoji=p.perfil.toLowerCase().includes('app')?'üì±':p.perfil.toLowerCase().includes('via')?'üõ£Ô∏è':p.perfil.toLowerCase().includes('pes')?'üöô':'üè†';
            const div=document.createElement('div');
            div.className='profile-pill'+(i===0?' active':'');
            if(i===0)selecionadoPerfil=p;
            div.innerHTML=`<div class="profile-emoji">${emoji}</div>
    <div class="profile-info">
      <div class="name">${p.perfil}</div>
      <div class="details">${toNumBR(p.km_ano).toLocaleString('pt-BR')} km/ano</div>
      <div class="details">Recarga P√∫blica: ${(toNumBR(p['%_recarga_publica'])*100).toFixed(0)}% ‚Ä¢ Rodovia: ${(toNumBR(p['%_rodovia'])*100).toFixed(0)}%</div>
    </div>`;
            div.onclick=()=>{document.querySelectorAll('.profile-pill').forEach(b=>b.classList.remove('active'));div.classList.add('active');selecionadoPerfil=p;};
            box.appendChild(div);
        });
    }

    // === POPULAR CEN√ÅRIOS ===
    function popularCenarios(){
        const wrap=document.getElementById('cenariosContainer');
        wrap.innerHTML='';
        dataCenarios.forEach(c=>{
            const icon=c.cenario.toLowerCase().includes('otim')?'üìà':c.cenario.toLowerCase().includes('pess')?'üìâ':'üìä';
            const btn=document.createElement('button');
            btn.className='scenario-btn';
            btn.innerHTML=`${icon} ${c.cenario}`;
            btn.onclick=()=>{
                document.querySelectorAll('.scenario-btn').forEach(b=>b.classList.remove('active'));
                btn.classList.add('active');
                selecionadoCenario=c;
                document.getElementById('tarifaRes').value=c.tarifa_residencial_kwh;
                document.getElementById('tarifaPub').value=c.tarifa_publica_kwh;
                document.getElementById('precoGas').value=c.preco_gasolina;
                document.getElementById('tma').value=(toNumBR(c.tma)*100).toLocaleString('pt-BR',{minimumFractionDigits:0});
                document.getElementById('anos').value=toNumBR(c.periodo);
            };
            wrap.appendChild(btn);
        });
        const base=dataCenarios.find(c=>c.cenario.toLowerCase().includes('base'))||dataCenarios[0];
        if(base){wrap.querySelectorAll('.scenario-btn')[dataCenarios.indexOf(base)].click();}
    }

    // === BLOCO DE C√ÅLCULOS ===
    function calcular(){

        // Prote√ß√µes
        if(!selecionadoEV || !selecionadoICE){
            alert("Por favor, selecione os dois modelos de ve√≠culos (El√©trico e Combust√£o) antes de calcular.");
            return;
        }
        if(!selecionadoPerfil || !selecionadoCenario){
            alert("Por favor, selecione um perfil e um cen√°rio antes de calcular.");
            return;
        }

        // Entradas do usu√°rio
        const tarifaRes=toNumBR(document.getElementById('tarifaRes').value);
        const tarifaPub=toNumBR(document.getElementById('tarifaPub').value);
        const precoGas=toNumBR(document.getElementById('precoGas').value);
        const kmAno=toNumBR(selecionadoPerfil.km_ano);
        const pctPub=toNumBR(selecionadoPerfil['%_recarga_publica']);
        const pctRodovia=toNumBR(selecionadoPerfil['%_rodovia']);

        // === PRE√áOS EDIT√ÅVEIS (snake_case) ===
        const preco_ev_str  = document.getElementById('precoEV').value.trim();
        const preco_ice_str = document.getElementById('precoICE').value.trim();

        const preco_ev  = preco_ev_str === "" ? toNumBR(selecionadoEV.preco_inicial)  : toNumBR(preco_ev_str);
        const preco_ice = preco_ice_str === "" ? toNumBR(selecionadoICE.preco_inicial) : toNumBR(preco_ice_str);


        // Dados dos ve√≠culos
        const cuEV=toNumBR(selecionadoEV.consumo_urb);
        const crEV=toNumBR(selecionadoEV.consumo_rod);
        const cuICE=toNumBR(selecionadoICE.consumo_urb);
        const crICE=toNumBR(selecionadoICE.consumo_rod);

        // C√°lculos de consumo m√©dio
        const consumoMedioEV=(cuEV*(1-pctRodovia))+(crEV*pctRodovia);
        const consumoMedioICE=(cuICE*(1-pctRodovia))+(crICE*pctRodovia);

        // Custo de energia e combust√≠vel
        const custoEnergiaEV=((1-pctPub)*tarifaRes)+(pctPub*tarifaPub);
        const custoKmEV=consumoMedioEV>0?(custoEnergiaEV/consumoMedioEV):0;
        const custoKmICE=consumoMedioICE>0?(precoGas/consumoMedioICE):0;

        // === CUSTO TOTAL EV ===
        const custoTotalEV = preco_ev
            + toNumBR(selecionadoEV.manutencao_anual)
            + toNumBR(selecionadoEV.seguro_anual)
            + toNumBR(selecionadoEV.ipva_anual)
            + toNumBR(selecionadoEV.pneus_ano)
            + (custoKmEV * kmAno);

        // === CUSTO TOTAL ICE ===
        const custoTotalICE = preco_ice
            + toNumBR(selecionadoICE.manutencao_anual)
            + toNumBR(selecionadoICE.seguro_anual)
            + toNumBR(selecionadoICE.ipva_anual)
            + toNumBR(selecionadoICE.pneus_ano)
            + (custoKmICE * kmAno);

        // Exibe resultados
        document.getElementById('resEV').textContent = moneyBR4(custoKmEV);
        document.getElementById('resICE').textContent = moneyBR4(custoKmICE);
        document.getElementById('custoEV').textContent = moneyBR(custoTotalEV);
        document.getElementById('custoICE').textContent = moneyBR(custoTotalICE);

        // (opcional para depura√ß√£o)
        // console.log("preco_ev:", preco_ev, "preco_ice:", preco_ice, "custoTotalEV:", custoTotalEV, "custoTotalICE:", custoTotalICE);
    }

    // === INICIALIZA√á√ÉO ===
    async function init(){
        [dataVeiculos,dataPerfis,dataCenarios]=await Promise.all([
            getCSV(URLS.VEICULOS),getCSV(URLS.PERFIS),getCSV(URLS.CENARIOS)
        ]);
        popularVeiculos();popularPerfis();popularCenarios();
        document.getElementById('selEV').addEventListener('change',e=>{
            const m=e.target.value;selecionadoEV=dataVeiculos.find(v=>v.modelo===m);
            atualizarInfoVeiculo(selecionadoEV,'infoEV','precoEV','imgEV',true);
        });
        document.getElementById('selICE').addEventListener('change',e=>{
            const m=e.target.value;selecionadoICE=dataVeiculos.find(v=>v.modelo===m);
            atualizarInfoVeiculo(selecionadoICE,'infoICE','precoICE','imgICE',false);
        });
        document.getElementById('btnCalcular').addEventListener('click',calcular);
    }
    init().catch(err=>alert('Erro ao carregar dados: '+err));
</script>
</body>
</html>
